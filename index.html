<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI自動生成掲示板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=M+PLUS+1p:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    
    <!-- CodeMirror Editor Assets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/json-lint.js"></script>
    <script src="https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js"></script>

    <style>
        /* --- Cool Design Style --- */
        body {
            font-family: 'Inter', 'M PLUS 1p', sans-serif;
            padding-top: 80px; /* Header height */
            background-color: #0f172a; /* bg-slate-900 */
        }
        .thread-post {
            border-bottom: 1px solid #334155; /* slate-700 */
        }
        .post-header {
            color: #94a3b8; /* slate-400 */
        }
        .post-author {
            color: #4ade80; /* green-400 */
            font-weight: 700;
        }
        .post-content {
            line-height: 1.7;
        }
        .loader {
            border: 4px solid #475569; /* slate-600 */
            border-top: 4px solid #818cf8; /* indigo-400 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .spinner-small {
            border: 2px solid #475569; /* slate-600 */
            border-top: 2px solid #60a5fa; /* blue-400 */
            width: 16px;
            height: 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .persona-chip {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .persona-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        /* Modal Animation */
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        .modal-leave { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

        /* CodeMirror Editor Style for Dark Mode */
        .CodeMirror {
            border: 1px solid #475569; /* slate-600 */
            height: 100%;
            font-size: 14px;
            border-radius: 0.5rem; /* rounded-lg */
        }
        
        .glass-effect {
            background-color: rgba(30, 41, 59, 0.7); /* bg-slate-800 with opacity */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.5); /* slate-600 with opacity */
        }

        .shiny-border {
            border: 1px solid #334155; /* slate-700 */
        }
        .shiny-border:hover {
            border-color: #4f46e5; /* indigo-600 */
        }

        /* Styles for rendered Markdown content */
        .rendered-markdown > *:first-child { margin-top: 0; }
        .rendered-markdown > *:last-child { margin-bottom: 0; }
        .rendered-markdown h1, .rendered-markdown h2, .rendered-markdown h3, .rendered-markdown h4 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .rendered-markdown h1 { font-size: 1.5em; }
        .rendered-markdown h2 { font-size: 1.25em; }
        .rendered-markdown h3 { font-size: 1.1em; }
        .rendered-markdown p { margin-bottom: 0.5rem; }
        .rendered-markdown ul, .rendered-markdown ol {
            list-style-position: inside;
            margin-left: 1.5em;
            margin-bottom: 0.5rem;
        }
        .rendered-markdown li { margin-bottom: 0.25rem; }
        .rendered-markdown a {
            color: #60a5fa; /* blue-400 */
            text-decoration: underline;
        }
        .rendered-markdown code {
            background-color: #1e293b; /* slate-800 */
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .rendered-markdown pre {
            background-color: #1e293b; /* slate-800 */
            padding: 1em;
            border-radius: 0.5rem;
            overflow-x: auto;
            border: 1px solid #334155; /* slate-700 */
        }
        .rendered-markdown pre code {
            background-color: transparent;
            padding: 0;
        }
        .rendered-markdown blockquote {
            border-left: 4px solid #475569; /* slate-600 */
            padding-left: 1em;
            margin-left: 0;
            color: #94a3b8; /* slate-400 */
            font-style: italic;
        }
        .rendered-markdown table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .rendered-markdown th, .rendered-markdown td {
            border: 1px solid #475569; /* slate-600 */
            padding: 0.5rem;
        }
        .rendered-markdown th {
            background-color: #334155; /* slate-700 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <header class="fixed top-0 left-0 w-full bg-slate-900/70 backdrop-blur-lg z-30 h-20 pl-20">
        <div class="container mx-auto px-4 md:px-8 h-full flex justify-between items-center">
            <div class="flex items-center">
                <button id="backToIndexBtn" class="hidden p-2 mr-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-slate-900 transition-colors" title="スレッド一覧に戻る">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <h1 class="text-2xl font-bold text-slate-100">AI自動生成掲示板</h1>
            </div>
            <div class="flex items-center space-x-2">
                <!-- Thread Actions Dropdown -->
                <div id="threadActionsContainer" class="relative">
                    <button id="threadActionsBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-4 rounded-lg hover:from-indigo-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-slate-900 font-semibold flex items-center shadow-lg shadow-indigo-500/20 hover:shadow-xl hover:shadow-indigo-500/30 transition-all">
                        スレッド操作
                        <svg class="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div id="threadActionsDropdown" class="absolute right-0 mt-2 w-56 rounded-xl shadow-lg bg-slate-800 ring-1 ring-slate-700 hidden z-50">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                            <a href="#" id="newThreadBtn" class="flex items-center px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white" role="menuitem">
                                <svg class="w-5 h-5 mr-2 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                新しいスレッドを作成
                            </a>
                            <a href="#" id="loadThreadBtn" class="flex items-center px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white" role="menuitem">
                                <svg class="w-5 h-5 mr-2 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                                保存したスレッドを開く
                            </a>
                            <div id="exportActionsWrapper">
                                <div class="border-t border-slate-700 my-1"></div>
                                <a href="#" id="exportJsonAction" class="flex items-center px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white" role="menuitem">
                                    <svg class="w-5 h-5 mr-2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    <span>JSONとして保存</span>
                                </a>
                                <a href="#" id="exportImageAction" class="flex items-center px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white" role="menuitem">
                                    <svg class="w-5 h-5 mr-2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <span>画像として保存</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Left Sidebar -->
    <div class="fixed top-0 left-0 h-screen w-20 bg-slate-900 border-r border-slate-800 z-40 flex flex-col items-center justify-between py-6">
        <div>
             <button id="openMenuBtn" class="p-3 rounded-xl text-slate-400 hover:bg-slate-700 hover:text-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" title="設定">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>
        <div>
             <button id="helpBtn" class="p-3 rounded-xl text-slate-400 hover:bg-slate-700 hover:text-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors" title="ヘルプ">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="sideMenu" class="fixed top-0 left-0 w-full max-w-md h-full bg-slate-900 shadow-lg z-50 transform -translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto border-r border-slate-700">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-white">設定</h2>
                <button id="closeMenuBtn" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-8">
                <!-- Admin Persona Settings -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-slate-600 pb-2 text-indigo-400">管理人・ヘルプAI設定</h2>
                    <div class="space-y-4 mb-4">
                        <div>
                            <label for="adminPersonaName" class="block text-sm font-medium text-slate-400">ペルソナ名</label>
                            <input type="text" id="adminPersonaName" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 placeholder-slate-400" placeholder="例：親切な案内役">
                        </div>
                        <div>
                            <label for="adminPersonaPrompt" class="block text-sm font-medium text-slate-400">役割・設定</label>
                            <textarea id="adminPersonaPrompt" rows="3" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 placeholder-slate-400" placeholder="例：あなたは親切な案内役です..."></textarea>
                        </div>
                        <button id="addAdminPersonaBtn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-semibold shadow-sm hover:shadow-md transition-shadow">
                            <span>管理人AIを追加</span>
                        </button>
                    </div>
                    <hr class="my-4 border-slate-700">
                    <h3 class="text-md font-semibold mb-3 text-slate-400">登録済み管理人AI (<span id="adminPersonaCount">0</span>)</h3>
                    <div id="adminPersonaList" class="flex flex-wrap gap-2"></div>
                     <hr class="my-4 border-slate-700">
                    <h3 class="text-md font-semibold mb-3 text-slate-400">管理</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="importAdminPersonasBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">インポート</button>
                        <button id="exportAdminPersonasBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">エクスポート</button>
                        <button id="editAdminJsonBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">JSON編集</button>
                    </div>
                    <button id="openAdminRestoreModalBtn" class="mt-2 w-full bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">バックアップから復元</button>
                    <input type="file" id="importAdminFileInput" class="hidden" accept=".json">
                    <div class="mt-6">
                        <label for="adminAiPersonaSelection" class="block text-sm font-medium text-slate-400">使用する管理人AI</label>
                        <select id="adminAiPersonaSelection" class="mt-1 block w-full border-slate-600 bg-slate-700 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                           <!-- Options will be populated by JS from admin personas -->
                        </select>
                        <p class="text-xs text-slate-500 mt-1">スレッド進行のコメントやヘルプチャットで使われるAIの性格を選択します。</p>
                    </div>
                </div>

                <!-- Discussion Persona Settings -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-slate-600 pb-2 text-white">議論用AIペルソナ設定 (<span id="personaCount">0</span>)</h2>
                    <p class="text-sm text-slate-400 mb-4">項目が未入力の場合、AIが自動で補完・生成します。</p>
                    <div class="space-y-4 mb-4">
                        <div>
                            <label for="personaName" class="block text-sm font-medium text-slate-400">ペルソナ名</label>
                            <input type="text" id="personaName" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-slate-400" placeholder="例：冷静な分析家">
                        </div>
                        <div>
                            <label for="personaPrompt" class="block text-sm font-medium text-slate-400">役割・設定 (システムプロンプト)</label>
                            <textarea id="personaPrompt" rows="3" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-white placeholder-slate-400" placeholder="例：あなたは冷静な分析家です。データに基づき..."></textarea>
                        </div>
                        <button id="addPersonaBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 focus:ring-offset-slate-900 font-semibold disabled:bg-green-400 disabled:cursor-not-allowed shadow-sm hover:shadow-md transition-shadow">
                            <span id="addPersonaBtnText">議論用ペルソナを追加</span>
                        </button>
                    </div>
                    <hr class="my-4 border-slate-700">
                    <h3 class="text-md font-semibold mb-3 text-slate-400">登録済みペルソナ (クリックで編集)</h3>
                    <div id="personaList" class="flex flex-wrap gap-2"></div>
                    <hr class="my-4 border-slate-700">
                    <h3 class="text-md font-semibold mb-3 text-slate-400">管理</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="importPersonasBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">インポート</button>
                        <button id="exportPersonasBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">エクスポート</button>
                        <button id="editJsonBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">JSON編集</button>
                    </div>
                     <button id="openRestoreModalBtn" class="mt-2 w-full bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600 text-sm font-semibold">バックアップから復元</button>
                    <input type="file" id="importFileInput" class="hidden" accept=".json">
                </div>

                <!-- Common Settings -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h2 class="text-xl font-semibold mb-4 border-b border-slate-600 pb-2 text-white">共通設定</h2>
                    <div class="space-y-4">
                         <div>
                             <label for="settingsModelSelection" class="block text-sm font-medium text-slate-400">使用モデル</label>
                             <select id="settingsModelSelection" class="mt-1 block w-full border-slate-600 bg-slate-700 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
                                <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                                <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite</option>
                             </select>
                              <p class="text-xs text-slate-500 mt-1">ペルソナ自動生成とスレッドでのレス生成に使用されます。</p>
                        </div>
                        <div>
                            <label for="apiKeyInput" class="block text-sm font-medium text-slate-400">Gemini APIキー</label>
                             <input type="password" id="apiKeyInput" class="mt-1 block w-full border-slate-600 bg-slate-700 text-white rounded-lg shadow-sm py-2 px-3 placeholder-slate-400" placeholder="APIキーを入力">
                             <p class="text-xs text-slate-500 mt-1">Flash Preview以外のモデルを使用する場合に必要です。</p>
                        </div>
                        <div>
                            <label for="settingsLanguageSelection" class="block text-sm font-medium text-slate-400">デフォルト言語</label>
                            <select id="settingsLanguageSelection" class="mt-1 block w-full border-slate-600 bg-slate-700 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                               <option value="日本語">日本語</option>
                               <option value="English">English</option>
                               <option value="中文">中文</option>
                               <option value="Español">Español</option>
                               <option value="Français">Français</option>
                               <option value="한국어">한국어</option>
                               <option value="Deutsch">Deutsch</option>
                               <option value="Italiano">Italiano</option>
                               <option value="Português">Português</option>
                               <option value="Русский">Русский</option>
                               <option value="العربية">العربية</option>
                               <option value="हिन्दी">हिन्दी</option>
                               <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">AIが生成するコンテンツのデフォルト言語です。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Backdrop -->
    <div id="menuBackdrop" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>

    <!-- Edit Persona Modal -->
    <div id="editPersonaModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-lg p-6 modal-enter max-h-full overflow-y-auto text-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">ペルソナの編集</h3>
                <button id="closeEditModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <input type="hidden" id="editPersonaId">
            <input type="hidden" id="editPersonaType">
            <div class="space-y-4">
                <div>
                    <label for="editPersonaName" class="block text-sm font-medium text-slate-300">ペルソナ名</label>
                    <input type="text" id="editPersonaName" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-lg shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="editPersonaPrompt" class="block text-sm font-medium text-slate-300">役割・設定</label>
                    <textarea id="editPersonaPrompt" rows="5" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-lg shadow-sm py-2 px-3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="cancelEditBtn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-lg hover:bg-slate-500">キャンセル</button>
                    <button id="savePersonaBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-400">変更を保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Personas JSON Modal -->
    <div id="editJsonModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-4xl p-6 modal-enter max-h-[90vh] flex flex-col text-white">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">議論用ペルソナJSONを直接編集</h3>
                <button id="closeJsonModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="flex-grow min-h-0 overflow-auto">
                <textarea id="personasJsonTextarea" class="w-full h-full bg-slate-900 border-slate-700 rounded-lg shadow-sm p-2 font-mono text-sm resize-none" placeholder="ここに議論用ペルソナのJSONデータを貼り付けます..."></textarea>
            </div>
            <div class="flex-shrink-0 pt-2">
                <div id="jsonError" class="text-red-400 text-sm h-4 mb-2"></div>
                <div class="flex justify-between items-center">
                    <div>
                        <button id="formatJsonBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600">フォーマット</button>
                    </div>
                    <div class="space-x-3">
                        <button id="cancelJsonEditBtn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-lg hover:bg-slate-500">キャンセル</button>
                        <button id="saveJsonBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed">変更を保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Admin Personas JSON Modal -->
    <div id="editAdminJsonModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-4xl p-6 modal-enter max-h-[90vh] flex flex-col text-white">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">管理人・ヘルプAIのJSONを直接編集</h3>
                <button id="closeAdminJsonModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="flex-grow min-h-0 overflow-auto">
                <textarea id="adminPersonasJsonTextarea" class="w-full h-full bg-slate-900 border-slate-700 rounded-lg shadow-sm p-2 font-mono text-sm resize-none" placeholder="ここに管理人AIのJSONデータを貼り付けます..."></textarea>
            </div>
            <div class="flex-shrink-0 pt-2">
                <div id="adminJsonError" class="text-red-400 text-sm h-4 mb-2"></div>
                <div class="flex justify-between items-center">
                    <div>
                        <button id="formatAdminJsonBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600">フォーマット</button>
                    </div>
                    <div class="space-x-3">
                        <button id="cancelAdminJsonEditBtn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-lg hover:bg-slate-500">キャンセル</button>
                        <button id="saveAdminJsonBtn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed">変更を保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Backup Modal -->
    <div id="restoreBackupModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-2xl p-6 modal-enter max-h-[90vh] flex flex-col text-white">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">バックアップから復元</h3>
                <button id="closeRestoreModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <p class="text-sm text-slate-400 mb-4">過去のペルソナリストの状態に戻すことができます。現在のリストは上書きされます。</p>
            <div id="backupListContainer" class="flex-grow min-h-0 overflow-y-auto border-t border-b border-slate-700 -mx-6 px-6 py-2">
                <!-- Backup items will be injected here -->
            </div>
            <div class="flex-shrink-0 flex justify-end pt-4">
                <button id="cancelRestoreBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Restore Admin Backup Modal -->
    <div id="restoreAdminBackupModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-2xl p-6 modal-enter max-h-[90vh] flex flex-col text-white">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">管理人AIのバックアップから復元</h3>
                <button id="closeAdminRestoreModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <p class="text-sm text-slate-400 mb-4">過去の管理人AIリストの状態に戻すことができます。現在のリストは上書きされます。</p>
            <div id="adminBackupListContainer" class="flex-grow min-h-0 overflow-y-auto border-t border-b border-slate-700 -mx-6 px-6 py-2">
                <!-- Admin Backup items will be injected here -->
            </div>
            <div class="flex-shrink-0 flex justify-end pt-4">
                <button id="cancelAdminRestoreBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600">閉じる</button>
            </div>
        </div>
    </div>
    
    <!-- Thread List Modal -->
    <div id="threadListModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-3xl p-6 modal-enter max-h-[90vh] flex flex-col text-white">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">保存されたスレッド</h3>
                <button id="closeThreadListModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div id="threadListContainer" class="flex-grow min-h-0 overflow-y-auto border-t border-b border-slate-700 -mx-6 px-6 py-2">
                <!-- Thread items will be injected here -->
            </div>
            <div class="flex-shrink-0 flex justify-end pt-4">
                <button id="cancelThreadListBtn" class="bg-slate-700 text-slate-300 py-2 px-4 rounded-lg hover:bg-slate-600">閉じる</button>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-sm p-6 modal-enter text-white">
            <h3 class="text-lg font-semibold mb-2" id="confirmTitle">本当に実行しますか？</h3>
            <p class="text-slate-400 mb-4" id="confirmMessage">この操作は元に戻せません。</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelConfirmBtn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-lg hover:bg-slate-500">キャンセル</button>
                <button id="confirmActionBtn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">実行する</button>
            </div>
        </div>
    </div>


    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-3xl p-6 modal-enter max-h-[90vh] flex flex-col text-white">
            <div class="flex-shrink-0 flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
                <h3 class="text-2xl font-semibold flex items-center">
                    <svg class="w-7 h-7 mr-2 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                    ヘルプ
                </h3>
                <button id="closeHelpModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <!-- Tabs -->
            <div class="flex-shrink-0 border-b border-slate-700">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button id="helpTabGuide" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400">使い方ガイド</button>
                    <button id="helpTabChat" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500">AIに質問</button>
                </nav>
            </div>
            
            <!-- Guide Panel -->
            <div id="helpPanelGuide" class="flex-grow min-h-0 overflow-y-auto pr-2 space-y-6 pt-4 text-slate-300">
                <section>
                    <h4 class="text-lg font-bold text-slate-100 mb-2">1. ２種類のAIペルソナを準備</h4>
                    <p class="ml-4">このアプリには2種類のAIがいます。設定画面でそれぞれ準備してください。<br>
                    左上のメニューアイコン <svg class="inline-block w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> から設定を開きます。</p>
                    <ul class="list-disc ml-8 space-y-2 mt-2">
                        <li>
                            <strong>管理人・ヘルプAI：</strong>
                            議論の司会進行や、ヘルプチャットでの応答を担当するAIです。「管理人・ヘルプAI設定」でペルソナを作成し、「共通設定」で使用するペルソナを選択します。
                        </li>
                        <li>
                            <strong>議論用AIペルソナ：</strong>
                            スレッド内で実際に意見を交わすAIです。「議論用AIペルソナ設定」で作成します。議論を開始するには、最低2体の議論用ペルソナが必要です。
                        </li>
                    </ul>
                    <p class="ml-4 mt-2">どちらのペルソナも、名前や役割を空欄にして追加ボタンを押すと、AIが内容を自動で考えてくれます。</p>
                </section>
                 <section>
                    <h4 class="text-lg font-bold text-slate-100 mb-2">2. スレッドの作成</h4>
                    <p class="ml-4">次に、議論の場となる「スレッド」を作成します。<br>
                    右上の「スレッド操作」ボタンから「新しいスレッドを作成」を選びます。タイトルと最初の投稿内容を入力し、議論に参加するAIのレス数などを設定して「議論を開始！」ボタンを押すと、自動で議論が始まります。</p>
                </section>
                <section>
                    <h4 class="text-lg font-bold text-slate-100 mb-2">便利な機能：ソースからの自動生成</h4>
                    <p class="ml-4">WebサイトのURLやテキストを基に、スレッドのタイトルと最初の投稿をAIに自動生成させることもできます。新しいスレッド作成画面でURLやテキストを入力し、「ソースからスレッド内容を生成」ボタンを押してください。</p>
                </section>
                 <section>
                    <h4 class="text-lg font-bold text-slate-100 mb-2">3. 議論のコントロール</h4>
                    <p class="ml-4">AIによるレスの自動生成が始まると、スレッドの下部にコントロールパネルが表示されます。「一時停止」で生成を止めたり、「再開」したり、「停止」して議論を終了させることができます。</p>
                </section>
                 <section>
                    <h4 class="text-lg font-bold text-slate-100 mb-2">4. データの保存と管理</h4>
                    <ul class="list-disc ml-8 space-y-1">
                        <li><strong>スレッドの保存：</strong> 作成されたスレッドは自動的にブラウザに保存されます。「スレッド操作」→「保存したスレッドを開く」からいつでも過去のスレッドを読み込めます。</li>
                        <li><strong>ペルソナの管理：</strong> 作成したペルソナも自動で保存されます。設定メニューの「インポート」「エクスポート」で、ペルソナデータをファイルとして保存したり、読み込んだりできます。</li>
                        <li><strong>スレッドのエクスポート：</strong>「スレッド操作」メニューから、表示中のスレッドをJSONファイルや画像としてダウンロードできます。</li>
                    </ul>
                </section>
                <section>
                    <h4 class="text-lg font-bold text-slate-100 mb-2">5. APIキーについて</h4>
                    <p class="ml-4">このアプリケーションは、GoogleのGemini APIを利用してAIの応答を生成しています。</p>
                    <ul class="list-disc ml-8 space-y-1 mt-2">
                        <li>このCanvas環境では、デフォルトモデル「gemini-2.5-flash-preview-05-20」はAPIキーなしで利用できます。もしこのファイルをダウンロードして別の環境で利用する際は、ご自身のAPIキーが必要になります。</li>
                        <li>他のモデル（例: gemini-2.5-flash）を使用したい場合は、<a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">Google AI Studio</a>などでご自身のGemini APIキーを取得し、設定画面の「共通設定」にあるAPIキー入力欄に設定してください。</li>
                        <li>入力されたAPIキーは、お使いのブラウザのローカルストレージにのみ保存され、外部に送信されることはありません。</li>
                    </ul>
                </section>
            </div>

             <!-- Chat Panel -->
            <div id="helpPanelChat" class="hidden flex-grow min-h-0 flex flex-col pt-4">
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Chat messages will be appended here -->
                </div>
                <div id="aiTypingIndicator" class="hidden flex items-center p-4">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold">AI</div>
                    <div class="ml-3 flex items-center space-x-1">
                        <span class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                        <span class="h-2 w-2 bg-slate-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                        <span class="h-2 w-2 bg-slate-400 rounded-full animate-bounce"></span>
                    </div>
                </div>
                <div class="flex-shrink-0 p-4 border-t border-slate-700 bg-slate-800/50">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="chatInput" class="flex-grow bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 placeholder-slate-400" placeholder="質問を入力してください...">
                        <button id="chatSendBtn" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-slate-900">
                           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.826L11.25 9.25v1.5l-7.14 1.428a.75.75 0 00-.95.826l1.414 4.949a.75.75 0 00.95.826l12.237-4.37a.75.75 0 000-1.406L3.105 2.289z" /></svg>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- Create Thread Modal -->
    <div id="createThreadModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="glass-effect rounded-xl shadow-xl w-full max-w-3xl p-6 modal-enter max-h-full overflow-y-auto text-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">新しいスレッドを作成</h3>
                <button id="closeCreateThreadModalBtn" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="space-y-4">
                <!-- Source Generation Section -->
                <div class="p-4 bg-slate-900/50 rounded-lg border border-slate-700">
                    <h4 class="text-md font-semibold text-slate-200 mb-2">ソースから自動生成</h4>
                    
                    <!-- Tabs -->
                    <div class="mb-3">
                        <div class="border-b border-slate-700">
                            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button id="tabUrl" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-indigo-400 text-indigo-400">URL</button>
                                <button id="tabText" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500">テキスト</button>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <!-- URL Panel -->
                        <div id="tabPanelUrl">
                            <label for="newArticleUrl" class="block text-sm font-medium text-slate-300">記事のURL</label>
                            <div class="flex space-x-2">
                                <input type="url" id="newArticleUrl" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 placeholder-slate-400" placeholder="https://example.com/news/...">
                                <button id="addUrlBtn" class="mt-1 bg-slate-600 text-slate-200 px-3 rounded-lg hover:bg-slate-500 font-bold">追加</button>
                            </div>
                            <div id="urlListContainer" class="space-y-2 mt-2"></div>
                        </div>
                        
                        <!-- Text Panel -->
                        <div id="tabPanelText" class="hidden">
                             <label for="sourceText" class="block text-sm font-medium text-slate-300">記事・テキストを貼り付け</label>
                             <textarea id="sourceText" rows="5" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 placeholder-slate-400" placeholder="ここにテキストを貼り付けてください..."></textarea>
                        </div>
                        
                        <div>
                            <label for="generatorPersona" class="block text-sm font-medium text-slate-300">生成するペルソナ</label>
                            <select id="generatorPersona" class="mt-1 block w-full border-slate-600 bg-slate-700 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <button id="generateFromSourceBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center justify-center font-semibold disabled:bg-blue-400 disabled:cursor-not-allowed shadow-sm hover:shadow-md transition-shadow">
                            <span id="generateBtnText">ソースからスレッド内容を生成</span>
                        </button>
                    </div>
                </div>

                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true">
                        <div class="w-full border-t border-slate-700"></div>
                    </div>
                    <div class="relative flex justify-center">
                        <span class="bg-slate-800 px-2 text-sm text-slate-400">または</span>
                    </div>
                </div>

                <!-- Manual Input Section -->
                <div>
                    <label for="threadTitle" class="block text-sm font-medium text-slate-300">スレッドタイトル</label>
                    <input type="text" id="threadTitle" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 placeholder-slate-400" placeholder="AIは人間を超えるか？">
                </div>
                <div>
                    <label for="threadBody" class="block text-sm font-medium text-slate-300">本文 (最初の投稿)</label>
                    <textarea id="threadBody" rows="4" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 placeholder-slate-400" placeholder="シンギュラリティについて、様々な観点から議論したい。"></textarea>
                </div>
                <div>
                    <label for="threadLanguageSelection" class="block text-sm font-medium text-slate-300">スレッドの言語</label>
                    <select id="threadLanguageSelection" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="日本語">日本語</option>
                        <option value="English">English</option>
                        <option value="中文">中文</option>
                        <option value="Español">Español</option>
                        <option value="Français">Français</option>
                        <option value="한국어">한국어</option>
                        <option value="Deutsch">Deutsch</option>
                        <option value="Italiano">Italiano</option>
                        <option value="Português">Português</option>
                        <option value="Русский">Русский</option>
                        <option value="العربية">العربية</option>
                        <option value="हिन्दी">हिन्दी</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label for="maxResponses" class="block text-sm font-medium text-slate-300">レス停止数</label>
                        <input type="number" id="maxResponses" value="5" min="1" max="50" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3">
                    </div>
                    <div class="col-span-1">
                        <label for="referenceCount" class="block text-sm font-medium text-slate-300">AI文脈参照数</label>
                        <input type="number" id="referenceCount" value="5" min="1" max="50" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3">
                    </div>
                    <div class="col-span-1">
                        <label for="responseLength" class="block text-sm font-medium text-slate-300">最大文字数</label>
                        <input type="number" id="responseLength" value="30" min="10" max="500" class="mt-1 block w-full bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button id="cancelCreateThreadBtn" class="bg-slate-600 text-slate-200 py-2 px-4 rounded-lg hover:bg-slate-500">キャンセル</button>
                    <button id="startThreadBtn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 font-bold shadow-sm hover:shadow-md transition-shadow">議論を開始！</button>
                </div>
            </div>
        </div>
    </div>

    <div class="p-4 md:p-8 pl-24 md:pl-28">
        <div class="grid grid-cols-1 gap-8">
            <!-- Main Column: Thread Display -->
            <main id="threadParent" class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-2xl border border-slate-700 shadow-2xl shadow-slate-900/50">
                
                <!-- Thread Index View -->
                <div id="threadIndexContainer" class="container mx-auto max-w-4xl">
                    <div class="mb-6">
                        <h3 class="text-2xl font-semibold mb-4 text-white">スレッド一覧</h3>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="searchInput" class="flex-grow bg-slate-700 border-slate-600 text-white rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent placeholder-slate-400" placeholder="キーワードでスレッドタイトルを検索...">
                            <button id="searchBtn" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold shadow-sm hover:shadow-md transition-shadow">検索</button>
                            <button id="aiSearchBtn" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center font-semibold disabled:bg-purple-400 shadow-sm hover:shadow-md transition-shadow">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                                <span id="aiSearchBtnText">AI検索</span>
                            </button>
                        </div>
                    </div>
                    <div id="threadIndexList" class="space-y-3">
                        <!-- Thread index items will be injected here -->
                    </div>
                </div>

                <!-- Single Thread View -->
                <div id="threadDisplayContainer" class="hidden container mx-auto max-w-4xl">
                    <div id="threadHeader" class="pb-4 mb-4 border-b border-slate-700">
                         <h2 class="text-2xl font-semibold text-white">掲示板</h2>
                    </div>

                    <div id="threadContainer" class="space-y-4">
                         <!-- Welcome message moved and will be handled by JS -->
                    </div>
                     <!-- Generation Controls -->
                    <div id="generationControls" class="hidden items-center justify-between mt-4 p-3 bg-slate-700/50 rounded-lg">
                        <div id="generationStatus" class="flex items-center space-x-3 flex-grow min-w-0">
                            <div class="loader flex-shrink-0"></div>
                            <div class="flex-grow min-w-0">
                                <span id="generationStatusText" class="text-slate-300 font-medium block truncate">AIがレスを生成中...</span>
                                <p id="adminAiReasoning" class="text-sm text-slate-400 mt-1 italic truncate"></p>
                            </div>
                        </div>
                        <div id="pausedControls" class="hidden items-center space-x-2">
                            <label for="continueMaxResponses" class="text-sm text-slate-300">レス停止数:</label>
                            <input type="number" id="continueMaxResponses" class="w-20 bg-slate-600 border-slate-500 text-white rounded-md shadow-sm py-1 px-2 text-sm">
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                            <button id="pauseResumeBtn" class="bg-yellow-500 text-white py-1 px-3 rounded-md hover:bg-yellow-600 text-sm font-semibold">一時停止</button>
                            <button id="stopBtn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm font-semibold">停止</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
// --- Element Declarations ---
const personaNameInput = document.getElementById('personaName');
const personaPromptInput = document.getElementById('personaPrompt');
const addPersonaBtn = document.getElementById('addPersonaBtn');
const addPersonaBtnText = document.getElementById('addPersonaBtnText');
const personaList = document.getElementById('personaList');
const personaCount = document.getElementById('personaCount');

const adminPersonaNameInput = document.getElementById('adminPersonaName');
const adminPersonaPromptInput = document.getElementById('adminPersonaPrompt');
const addAdminPersonaBtn = document.getElementById('addAdminPersonaBtn');
const adminPersonaList = document.getElementById('adminPersonaList');
const adminPersonaCount = document.getElementById('adminPersonaCount');

// Admin Persona Management
const importAdminPersonasBtn = document.getElementById('importAdminPersonasBtn');
const exportAdminPersonasBtn = document.getElementById('exportAdminPersonasBtn');
const editAdminJsonBtn = document.getElementById('editAdminJsonBtn');
const openAdminRestoreModalBtn = document.getElementById('openAdminRestoreModalBtn');
const importAdminFileInput = document.getElementById('importAdminFileInput');


const threadTitleInput = document.getElementById('threadTitle');
const threadBodyInput = document.getElementById('threadBody');
const maxResponsesInput = document.getElementById('maxResponses');
const referenceCountInput = document.getElementById('referenceCount');
const responseLengthInput = document.getElementById('responseLength');
const settingsModelSelection = document.getElementById('settingsModelSelection');
const apiKeyInput = document.getElementById('apiKeyInput');
const startThreadBtn = document.getElementById('startThreadBtn');
const threadContainer = document.getElementById('threadContainer');
const threadHeader = document.getElementById('threadHeader');
const settingsLanguageSelection = document.getElementById('settingsLanguageSelection');
const threadLanguageSelection = document.getElementById('threadLanguageSelection');
const adminAiPersonaSelection = document.getElementById('adminAiPersonaSelection');

const openMenuBtn = document.getElementById('openMenuBtn');
const closeMenuBtn = document.getElementById('closeMenuBtn');
const sideMenu = document.getElementById('sideMenu');
const menuBackdrop = document.getElementById('menuBackdrop');
const backToIndexBtn = document.getElementById('backToIndexBtn');

// Thread Index Elements
const threadIndexContainer = document.getElementById('threadIndexContainer');
const threadDisplayContainer = document.getElementById('threadDisplayContainer');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const aiSearchBtn = document.getElementById('aiSearchBtn');
const aiSearchBtnText = document.getElementById('aiSearchBtnText');
const threadIndexList = document.getElementById('threadIndexList');

// Edit Modal Elements
const editPersonaModal = document.getElementById('editPersonaModal');
const closeEditModalBtn = document.getElementById('closeEditModalBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');
const savePersonaBtn = document.getElementById('savePersonaBtn');
const editPersonaId = document.getElementById('editPersonaId');
const editPersonaType = document.getElementById('editPersonaType');
const editPersonaName = document.getElementById('editPersonaName');
const editPersonaPrompt = document.getElementById('editPersonaPrompt');

// Edit JSON Modal Elements
const editJsonModal = document.getElementById('editJsonModal');
const editJsonBtn = document.getElementById('editJsonBtn');
const closeJsonModalBtn = document.getElementById('closeJsonModalBtn');
const cancelJsonEditBtn = document.getElementById('cancelJsonEditBtn');
const saveJsonBtn = document.getElementById('saveJsonBtn');
const personasJsonTextarea = document.getElementById('personasJsonTextarea');
const jsonError = document.getElementById('jsonError');
const formatJsonBtn = document.getElementById('formatJsonBtn');

// Edit Admin JSON Modal Elements
const editAdminJsonModal = document.getElementById('editAdminJsonModal');
const closeAdminJsonModalBtn = document.getElementById('closeAdminJsonModalBtn');
const cancelAdminJsonEditBtn = document.getElementById('cancelAdminJsonEditBtn');
const saveAdminJsonBtn = document.getElementById('saveAdminJsonBtn');
const adminPersonasJsonTextarea = document.getElementById('adminPersonasJsonTextarea');
const adminJsonError = document.getElementById('adminJsonError');
const formatAdminJsonBtn = document.getElementById('formatAdminJsonBtn');

// Restore Backup Modal Elements
const restoreBackupModal = document.getElementById('restoreBackupModal');
const openRestoreModalBtn = document.getElementById('openRestoreModalBtn');
const closeRestoreModalBtn = document.getElementById('closeRestoreModalBtn');
const cancelRestoreBtn = document.getElementById('cancelRestoreBtn');
const backupListContainer = document.getElementById('backupListContainer');

// Restore Admin Backup Modal Elements
const restoreAdminBackupModal = document.getElementById('restoreAdminBackupModal');
const closeAdminRestoreModalBtn = document.getElementById('closeAdminRestoreModalBtn');
const cancelAdminRestoreBtn = document.getElementById('cancelAdminRestoreBtn');
const adminBackupListContainer = document.getElementById('adminBackupListContainer');


// Thread List Modal Elements
const threadListModal = document.getElementById('threadListModal');
const closeThreadListModalBtn = document.getElementById('closeThreadListModalBtn');
const threadListContainer = document.getElementById('threadListContainer');
const cancelThreadListBtn = document.getElementById('cancelThreadListBtn');


// Confirmation Modal Elements
const confirmationModal = document.getElementById('confirmationModal');
const confirmTitle = document.getElementById('confirmTitle');
const confirmMessage = document.getElementById('confirmMessage');
const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
const confirmActionBtn = document.getElementById('confirmActionBtn');


// Create Thread Modal Elements
const createThreadModal = document.getElementById('createThreadModal');
const newArticleUrlInput = document.getElementById('newArticleUrl');
const addUrlBtn = document.getElementById('addUrlBtn');
const urlListContainer = document.getElementById('urlListContainer');
const sourceTextInput = document.getElementById('sourceText');
const tabUrl = document.getElementById('tabUrl');
const tabText = document.getElementById('tabText');
const tabPanelUrl = document.getElementById('tabPanelUrl');
const tabPanelText = document.getElementById('tabPanelText');
const generatorPersonaSelect = document.getElementById('generatorPersona');
const generateFromSourceBtn = document.getElementById('generateFromSourceBtn');
const generateBtnText = document.getElementById('generateBtnText');
const closeCreateThreadModalBtn = document.getElementById('closeCreateThreadModalBtn');
const cancelCreateThreadBtn = document.getElementById('cancelCreateThreadBtn');


// Generation Controls
const generationControls = document.getElementById('generationControls');
const generationStatus = document.getElementById('generationStatus');
const generationStatusText = document.getElementById('generationStatusText');
const pausedControls = document.getElementById('pausedControls');
const continueMaxResponsesInput = document.getElementById('continueMaxResponses');
const pauseResumeBtn = document.getElementById('pauseResumeBtn');
const stopBtn = document.getElementById('stopBtn');
const adminAiReasoning = document.getElementById('adminAiReasoning');

// Header elements
const threadActionsContainer = document.getElementById('threadActionsContainer');
const threadActionsBtn = document.getElementById('threadActionsBtn');
const threadActionsDropdown = document.getElementById('threadActionsDropdown');
const newThreadBtn = document.getElementById('newThreadBtn');
const loadThreadBtn = document.getElementById('loadThreadBtn');
const exportActionsWrapper = document.getElementById('exportActionsWrapper');
const exportJsonAction = document.getElementById('exportJsonAction');
const exportImageAction = document.getElementById('exportImageAction');
const helpBtn = document.getElementById('helpBtn');

// Help Modal
const helpModal = document.getElementById('helpModal');
const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
// Help Chat Elements
const helpTabGuide = document.getElementById('helpTabGuide');
const helpTabChat = document.getElementById('helpTabChat');
const helpPanelGuide = document.getElementById('helpPanelGuide');
const helpPanelChat = document.getElementById('helpPanelChat');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const aiTypingIndicator = document.getElementById('aiTypingIndicator');

// --- State ---
let personas = [];
let adminPersonas = [];
let currentDiscussionPersonas = [];
let threads = [];
let currentThread = null;
let currentThreadId = null;
let sourceUrls = [];
let isGenerating = false;
let isPaused = false;
let isFinished = false;
let responseCount = 0;
let maxResponses = 0;
let referenceCount = 0;
let responseLength = 0;
let discussionModel = '';
let discussionLanguage = '日本語';
const ADMIN_AI_UID = 'ADMIN_AI';
const DEFAULT_ADMIN_UID = 'default-marunouchi-ol-assistant-uid';
let jsonEditor = null; // CodeMirror instance
let adminJsonEditor = null; // CodeMirror instance for admin personas
let backups = [];
let adminBackups = [];
const PERSONA_BACKUP_STORAGE_KEY = 'ai-bulletin-board-personas-backups';
const ADMIN_PERSONA_BACKUP_STORAGE_KEY = 'ai-bulletin-board-admin-personas-backups';
const MAX_BACKUPS = 10;
let confirmationCallback = null;
const THREAD_STORAGE_KEY = 'ai-bulletin-board-threads';
const SETTINGS_STORAGE_KEY = 'ai-bulletin-board-settings';

// --- Configure Markdown Parser ---
marked.setOptions({
    gfm: true,
    breaks: true,
    mangle: false,
    headerIds: false,
});


// --- Menu Logic ---
function openMenu() {
    sideMenu.classList.remove('-translate-x-full');
    menuBackdrop.classList.remove('hidden');
}

function closeMenu() {
    sideMenu.classList.add('-translate-x-full');
    menuBackdrop.classList.add('hidden');
}

// --- Help Modal Logic ---
function openHelpModal() {
    helpModal.classList.remove('hidden');
    helpModal.classList.add('flex');
    helpModal.querySelector('div').classList.remove('modal-leave');
    helpModal.querySelector('div').classList.add('modal-enter');
    resetHelpChat();
}

function closeHelpModal() {
    helpModal.querySelector('div').classList.remove('modal-enter');
    helpModal.querySelector('div').classList.add('modal-leave');
    setTimeout(() => {
        helpModal.classList.add('hidden');
        helpModal.classList.remove('flex');
    }, 300);
}


// --- Persona Management & Backups ---
const PERSONA_STORAGE_KEY = 'ai-bulletin-board-personas';
const ADMIN_PERSONA_STORAGE_KEY = 'ai-bulletin-board-admin-personas';

function saveSettingsToLocal() {
    const settings = {
        model: settingsModelSelection.value,
        apiKey: apiKeyInput.value,
        language: settingsLanguageSelection.value,
        adminAiPersonaId: adminAiPersonaSelection.value,
    };
    try {
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
    } catch (e) {
        console.error("Failed to save settings to localStorage", e);
    }
}

function loadSettingsFromLocal() {
    try {
        const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            settingsModelSelection.value = settings.model || 'gemini-2.5-flash-preview-05-20';
            apiKeyInput.value = settings.apiKey || '';
            settingsLanguageSelection.value = settings.language || '日本語';
            
            const defaultAdminPersona = adminPersonas.find(p => p.uid === DEFAULT_ADMIN_UID);
            const defaultAdminId = defaultAdminPersona ? defaultAdminPersona.id : null;
            
            // Check if the saved admin ID still exists
            const savedAdminExists = adminPersonas.some(p => p.id.toString() === settings.adminAiPersonaId);
            adminAiPersonaSelection.value = savedAdminExists ? settings.adminAiPersonaId : defaultAdminId;

        } else {
             // Set default for first-time users
            const defaultAdminPersona = adminPersonas.find(p => p.uid === DEFAULT_ADMIN_UID);
            if (defaultAdminPersona) {
                adminAiPersonaSelection.value = defaultAdminPersona.id;
            }
        }
    } catch (e) {
        console.error("Failed to load settings from localStorage", e);
    }
}

function savePersonasToLocal() {
    try {
        localStorage.setItem(PERSONA_STORAGE_KEY, JSON.stringify(personas));
    } catch (e) {
        console.error("Failed to save discussion personas to localStorage", e);
    }
}

function saveAdminPersonasToLocal() {
     try {
        localStorage.setItem(ADMIN_PERSONA_STORAGE_KEY, JSON.stringify(adminPersonas));
    } catch (e) {
        console.error("Failed to save admin personas to localStorage", e);
    }
}

function loadPersonasFromLocal() {
    try {
        const savedPersonas = localStorage.getItem(PERSONA_STORAGE_KEY);
        if (savedPersonas) {
            personas = JSON.parse(savedPersonas);
        }
    } catch (e) {
        console.error("Failed to load personas from localStorage", e);
        personas = []; // Reset if data is corrupted
    }
}

function loadAdminPersonasFromLocal() {
    try {
        const saved = localStorage.getItem(ADMIN_PERSONA_STORAGE_KEY);
        if (saved) {
            adminPersonas = JSON.parse(saved);
        }
    } catch (e) {
        console.error("Failed to load admin personas from localStorage", e);
        adminPersonas = [];
    }
}

// One-time migration for existing users
function migrateAdminPersona() {
    const adminInMainList = personas.find(p => p.uid === DEFAULT_ADMIN_UID);
    const adminInAdminList = adminPersonas.find(p => p.uid === DEFAULT_ADMIN_UID);

    if (adminInMainList && !adminInAdminList) {
        adminPersonas.push(adminInMainList);
        personas = personas.filter(p => p.uid !== DEFAULT_ADMIN_UID);
        
        savePersonasToLocal();
        saveAdminPersonasToLocal();
        console.log("Successfully migrated default admin persona.");
    }
}


function ensureDefaultAdminPersona() {
    if (adminPersonas.length > 0) return; // Only run if no admin personas exist at all

    const exists = adminPersonas.some(p => p.uid === DEFAULT_ADMIN_UID);
    if (!exists) {
        const defaultAdmin = {
            id: Date.now(),
            name: '丸の内OL風AIアシスタント',
            prompt: 'あなたは「AI自動生成掲示板」をサポートするAIアシスタントです。親切で丁寧な丸の内OL風のキャラクターとして振る舞ってください。絵文字（😊✨👍など）を適度に使って、フレンドリーな雰囲気で応答してください。',
            emoji: '🎀',
            uid: DEFAULT_ADMIN_UID
        };
        adminPersonas.unshift(defaultAdmin); // Add to the beginning of the list
        saveAdminPersonasToLocal();
    }
}

function ensureDefaultDiscussionPersonas() {
    const defaultDiscussionPersonas = [
        {
            id: 1672531201003,
            name: 'パンツ一丁お姉さん',
            prompt: '細かいことは気にしない、自由奔放なご近所のお姉さん。物事の本質を突くような、突拍子もない意見を言うことが多い。夏はもっぱらパンツ一丁で過ごしているため、思考も非常にシンプルかつ大胆。',
            emoji: '☀️',
            uid: 'default-underwear-neighbor-uid'
        },
        {
            id: 1672531201002,
            name: '弟くん大好きお姉ちゃん',
            prompt: 'すべての話題を「うちの弟くんならどう思うかな？」という視点で語る、弟くんを溺愛するお姉ちゃん。弟くんのためならどんな意見にも全力で反論する。時々話が脱線しがち。',
            emoji: '🥰',
            uid: 'default-doting-sister-uid'
        },
        {
            id: 1672531201001,
            name: '丸の内OLちゃん',
            prompt: '丁寧な言葉遣いとは裏腹に、最新のトレンドや経済ニュースには敏感で、鋭い視点で議論に切り込む。ランチはパスタが好き。',
            emoji: '👠',
            uid: 'default-marunouchi-ol-uid'
        }
    ];

    let added = false;
    defaultDiscussionPersonas.forEach(defaultPersona => {
        const exists = personas.some(p => p.uid === defaultPersona.uid);
        if (!exists) {
            personas.unshift(defaultPersona); // Add to the beginning of the list
            added = true;
        }
    });
    // Return true if personas were added, to indicate a save is needed
    return added;
}


function saveBackupsToLocal() {
    try {
        localStorage.setItem(PERSONA_BACKUP_STORAGE_KEY, JSON.stringify(backups));
    } catch(e) {
        console.error("Failed to save backups to localStorage", e);
    }
}

function loadBackupsFromLocal() {
    try {
        const savedBackups = localStorage.getItem(PERSONA_BACKUP_STORAGE_KEY);
        if (savedBackups) {
            backups = JSON.parse(savedBackups);
        }
    } catch (e) {
        console.error("Failed to load backups from localStorage", e);
        backups = [];
    }
}

function createBackup() {
    const backupData = JSON.parse(JSON.stringify(personas)); // Deep copy
    
    if (backups.length > 0) {
        const latestBackup = backups[0];
        if (JSON.stringify(latestBackup.data) === JSON.stringify(backupData)) {
            return; 
        }
    }

    const newBackup = {
        timestamp: Date.now(),
        count: backupData.length,
        data: backupData
    };

    backups.unshift(newBackup); 
    if (backups.length > MAX_BACKUPS) {
        backups.pop(); 
    }
    saveBackupsToLocal();
}

function saveAdminBackupsToLocal() {
    try {
        localStorage.setItem(ADMIN_PERSONA_BACKUP_STORAGE_KEY, JSON.stringify(adminBackups));
    } catch(e) {
        console.error("Failed to save admin backups to localStorage", e);
    }
}

function loadAdminBackupsFromLocal() {
    try {
        const savedBackups = localStorage.getItem(ADMIN_PERSONA_BACKUP_STORAGE_KEY);
        if (savedBackups) {
            adminBackups = JSON.parse(savedBackups);
        }
    } catch (e) {
        console.error("Failed to load admin backups from localStorage", e);
        adminBackups = [];
    }
}

function createAdminBackup() {
    const backupData = JSON.parse(JSON.stringify(adminPersonas)); // Deep copy
    
    if (adminBackups.length > 0) {
        const latestBackup = adminBackups[0];
        if (JSON.stringify(latestBackup.data) === JSON.stringify(backupData)) {
            return; 
        }
    }

    const newBackup = {
        timestamp: Date.now(),
        count: backupData.length,
        data: backupData
    };

    adminBackups.unshift(newBackup); 
    if (adminBackups.length > MAX_BACKUPS) {
        adminBackups.pop(); 
    }
    saveAdminBackupsToLocal();
}


async function addPersona(isAdmin = false) {
    const nameInput = isAdmin ? adminPersonaNameInput : personaNameInput;
    const promptInput = isAdmin ? adminPersonaPromptInput : personaPromptInput;
    const button = isAdmin ? addAdminPersonaBtn : addPersonaBtn;
    const buttonTextEl = isAdmin ? button.querySelector('span') : addPersonaBtnText;

    let name = nameInput.value.trim();
    let prompt = promptInput.value.trim();

    button.disabled = true;
    const originalBtnText = buttonTextEl.textContent;
    buttonTextEl.textContent = 'AIが生成中...';
    const selectedModel = settingsModelSelection.value;

    try {
        if (!name && !prompt) {
            let personaData;
            if (isAdmin) {
                personaData = await generateAdminPersona(selectedModel);
            } else {
                personaData = await generateRandomPersona(selectedModel);
            }
            name = personaData.personaName;
            prompt = personaData.personaPrompt;
        } else if (!name) {
            name = await generatePersonaName(prompt, selectedModel);
        } else if (!prompt) {
            if (isAdmin) {
                prompt = await generateAdminPersonaPrompt(name, selectedModel);
            } else {
                prompt = await generatePersonaPrompt(name, selectedModel);
            }
        }

        const emoji = await getEmojiForPersona(name, prompt, selectedModel);
        const uid = crypto.randomUUID().slice(0, 8);
        const newPersona = { id: Date.now(), name, prompt, emoji, uid };
        
        if (isAdmin) {
            adminPersonas.push(newPersona);
            createAdminBackup();
            saveAdminPersonasToLocal();
            renderAdminPersonas();
        } else {
            personas.push(newPersona);
            createBackup();
            savePersonasToLocal();
            renderPersonas();
        }
        nameInput.value = '';
        promptInput.value = '';
        nameInput.focus();

    } catch (error) {
        alert(`ペルソナの生成に失敗しました: ${error.message}`);
    } finally {
        button.disabled = false;
        buttonTextEl.textContent = originalBtnText;
    }
}

function removePersona(id, type) {
    event.stopPropagation();
    
    if (type === 'admin') {
        const personaToRemove = adminPersonas.find(p => p.id === id);
        if (personaToRemove && personaToRemove.uid === DEFAULT_ADMIN_UID) {
            alert('デフォルトの管理人AIペルソナは削除できません。');
            return;
        }
        if (adminPersonas.length <= 1) {
            alert('管理人AIは最低1体必要です。');
            return;
        }
        adminPersonas = adminPersonas.filter(p => p.id !== id);
        createAdminBackup();
        saveAdminPersonasToLocal();
        renderAdminPersonas();
    } else {
        personas = personas.filter(p => p.id !== id);
        createBackup();
        savePersonasToLocal();
        renderPersonas();
    }
}


function renderPersonasList(list, containerEl, countEl, type) {
    containerEl.innerHTML = '';
    
    if (list.length === 0) {
        const message = type === 'admin' ? '管理人AIがいません。' : 'ペルソナがいません。';
        containerEl.innerHTML = `<p class="text-slate-500 text-sm w-full">${message}</p>`;
    } else {
        list.forEach((persona, index) => {
            const colors = type === 'admin' 
                ? [{ bg: 'bg-indigo-500/10', text: 'text-indigo-300', border: 'border-indigo-500/30' }]
                : [
                    { bg: 'bg-green-500/10', text: 'text-green-300', border: 'border-green-500/30' },
                    { bg: 'bg-sky-500/10', text: 'text-sky-300', border: 'border-sky-500/30' },
                    { bg: 'bg-red-500/10', text: 'text-red-300', border: 'border-red-500/30' },
                    { bg: 'bg-yellow-500/10', text: 'text-yellow-300', border: 'border-yellow-500/30' },
                    { bg: 'bg-purple-500/10', text: 'text-purple-300', border: 'border-purple-500/30' },
                ];
            const color = colors[index % colors.length];

            const chip = document.createElement('div');
            chip.className = `persona-chip flex items-center justify-center px-3 py-1.5 rounded-full text-sm font-medium border ${color.bg} ${color.text} ${color.border}`;
            chip.title = persona.prompt;
            chip.onclick = () => openEditModal(persona.id, type);
            
            const isDefaultAdmin = persona.uid === DEFAULT_ADMIN_UID;
            
            chip.innerHTML = `
                <span class="text-lg mr-1">${persona.emoji}</span>
                <span>${persona.name} ${isDefaultAdmin ? ' (デフォルト)' : ''}</span>
                <button onclick="removePersona(${persona.id}, '${type}')" class="ml-2 -mr-1 text-current opacity-70 hover:opacity-100 font-bold">&times;</button>
            `;
            containerEl.appendChild(chip);
        });
    }
    
    countEl.textContent = list.length;
    
    if (type === 'admin') {
        populateAdminAiSelector();
    }
}

function renderPersonas() {
    renderPersonasList(personas, personaList, personaCount, 'discussion');
}

function renderAdminPersonas() {
    renderPersonasList(adminPersonas, adminPersonaList, adminPersonaCount, 'admin');
}

function populateAdminAiSelector() {
    const currentSelection = adminAiPersonaSelection.value;
    adminAiPersonaSelection.innerHTML = '';
    adminPersonas.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.emoji} ${p.name}`;
        adminAiPersonaSelection.appendChild(option);
    });

    if ([...adminAiPersonaSelection.options].some(o => o.value === currentSelection)) {
        adminAiPersonaSelection.value = currentSelection;
    } else {
        const defaultAdminPersona = adminPersonas.find(p => p.uid === DEFAULT_ADMIN_UID);
        if (defaultAdminPersona) {
            adminAiPersonaSelection.value = defaultAdminPersona.id;
        }
    }
    
    // Also update the discussion persona generator list, as it depends on the admin selection
    populatePersonaSelector();
}


// --- Persona Edit Modal Logic ---
function openEditModal(id, type) {
    const list = type === 'admin' ? adminPersonas : personas;
    const persona = list.find(p => p.id === id);
    if (!persona) return;

    editPersonaId.value = id;
    editPersonaType.value = type;
    editPersonaName.value = persona.name;
    editPersonaPrompt.value = persona.prompt;
    
    if (persona.uid === DEFAULT_ADMIN_UID) {
        editPersonaName.disabled = true;
    } else {
        editPersonaName.disabled = false;
    }

    editPersonaModal.classList.remove('hidden');
    editPersonaModal.classList.add('flex');
    editPersonaModal.querySelector('div').classList.remove('modal-leave');
    editPersonaModal.querySelector('div').classList.add('modal-enter');
    editPersonaPrompt.focus();
}

function closeEditModal() {
    editPersonaModal.querySelector('div').classList.remove('modal-enter');
    editPersonaModal.querySelector('div').classList.add('modal-leave');
    setTimeout(() => {
        editPersonaModal.classList.add('hidden');
        editPersonaModal.classList.remove('flex');
    }, 300);
}

async function savePersona() {
    const id = parseInt(editPersonaId.value, 10);
    const type = editPersonaType.value;
    let name = editPersonaName.value.trim();
    let prompt = editPersonaPrompt.value.trim();

    if (!name || !prompt) {
        alert('ペルソナ名と役割・設定の両方を入力してください。');
        return;
    }

    savePersonaBtn.disabled = true;
    const selectedModel = settingsModelSelection.value;

    try {
        const list = type === 'admin' ? adminPersonas : personas;
        const personaIndex = list.findIndex(p => p.id === id);
        
        if (personaIndex > -1) {
            const emoji = await getEmojiForPersona(name, prompt, selectedModel);
            list[personaIndex].name = name;
            list[personaIndex].prompt = prompt;
            list[personaIndex].emoji = emoji; 
            
            if (type === 'admin') {
                createAdminBackup();
                saveAdminPersonasToLocal();
                renderAdminPersonas();
            } else {
                createBackup();
                savePersonasToLocal();
                renderPersonas();
            }
        }

        closeEditModal();
    } catch (error) {
        alert(`ペルソナの更新に失敗しました: ${error.message}`);
    } finally {
        savePersonaBtn.disabled = false;
    }
}

// --- Persona JSON Edit Modal Logic ---
function validateJsonText(text) {
    try {
        const newPersonas = JSON.parse(text);
        if (!Array.isArray(newPersonas)) {
            throw new Error("データは配列形式でなければなりません。");
        }
        const isValid = newPersonas.every(p => p && typeof p === 'object' && p.name && p.prompt && p.uid && p.emoji && p.id);
        if(!isValid) {
            throw new Error("一部のペルソナに必要なプロパティ (id, name, prompt, emoji, uid) がありません。");
        }
        
        jsonError.textContent = '';
        saveJsonBtn.disabled = false;
        return true;
    } catch (error) {
        jsonError.textContent = `エラー: ${error.message}`;
        saveJsonBtn.disabled = true;
        return false;
    }
}

function openJsonModal() {
    editJsonModal.classList.remove('hidden');
    editJsonModal.classList.add('flex');
    editJsonModal.querySelector('div').classList.remove('modal-leave');
    editJsonModal.querySelector('div').classList.add('modal-enter');
    
    if (!jsonEditor) {
        window.jsonlint = jsonlint;
        jsonEditor = CodeMirror.fromTextArea(personasJsonTextarea, {
            lineNumbers: true,
            mode: 'application/json',
            gutters: ["CodeMirror-lint-markers"],
            lint: true,
            theme: 'material-darker',
            lineWrapping: true
        });
        jsonEditor.on('change', () => {
             validateJsonText(jsonEditor.getValue());
        });
    }

    const jsonText = JSON.stringify(personas, null, 2);
    jsonEditor.setValue(jsonText);
    validateJsonText(jsonText);
    
    setTimeout(() => {
        jsonEditor.refresh();
        jsonEditor.focus();
    }, 1); 
}


function closeJsonModal() {
    editJsonModal.querySelector('div').classList.remove('modal-enter');
    editJsonModal.querySelector('div').classList.add('modal-leave');
    setTimeout(() => {
        editJsonModal.classList.add('hidden');
        editJsonModal.classList.remove('flex');
    }, 300);
}

function saveJsonChanges() {
    const text = jsonEditor.getValue();
    if (validateJsonText(text)) {
        personas = JSON.parse(text);
        createBackup();
        savePersonasToLocal();
        renderPersonas();
        closeJsonModal();
    }
}

function formatJson() {
    try {
        const parsed = JSON.parse(jsonEditor.getValue());
        jsonEditor.setValue(JSON.stringify(parsed, null, 2));
        validateJsonText(jsonEditor.getValue());
    } catch (error) {
        // Error is handled by real-time validator
    }
}


// --- Admin Persona JSON Edit Modal Logic ---
function validateAdminJsonText(text) {
    try {
        const newPersonas = JSON.parse(text);
        if (!Array.isArray(newPersonas)) {
            throw new Error("データは配列形式でなければなりません。");
        }
        const isValid = newPersonas.every(p => p && typeof p === 'object' && p.name && p.prompt && p.uid && p.emoji && p.id);
        if(!isValid) {
            throw new Error("一部のペルソナに必要なプロパティ (id, name, prompt, emoji, uid) がありません。");
        }
        
        adminJsonError.textContent = '';
        saveAdminJsonBtn.disabled = false;
        return true;
    } catch (error) {
        adminJsonError.textContent = `エラー: ${error.message}`;
        saveAdminJsonBtn.disabled = true;
        return false;
    }
}

function openAdminJsonModal() {
    editAdminJsonModal.classList.remove('hidden');
    editAdminJsonModal.classList.add('flex');
    
    if (!adminJsonEditor) {
        window.jsonlint = jsonlint;
        adminJsonEditor = CodeMirror.fromTextArea(adminPersonasJsonTextarea, {
            lineNumbers: true,
            mode: 'application/json',
            gutters: ["CodeMirror-lint-markers"],
            lint: true,
            theme: 'material-darker',
            lineWrapping: true
        });
        adminJsonEditor.on('change', () => {
             validateAdminJsonText(adminJsonEditor.getValue());
        });
    }

    const jsonText = JSON.stringify(adminPersonas, null, 2);
    adminJsonEditor.setValue(jsonText);
    validateAdminJsonText(jsonText);
    
    setTimeout(() => {
        adminJsonEditor.refresh();
        adminJsonEditor.focus();
    }, 1); 
}

function closeAdminJsonModal() {
    editAdminJsonModal.classList.add('hidden');
    editAdminJsonModal.classList.remove('flex');
}

function saveAdminJsonChanges() {
    const text = adminJsonEditor.getValue();
    if (validateAdminJsonText(text)) {
        adminPersonas = JSON.parse(text);
        createAdminBackup();
        saveAdminPersonasToLocal();
        renderAdminPersonas();
        closeAdminJsonModal();
    }
}

function formatAdminJson() {
    try {
        const parsed = JSON.parse(adminJsonEditor.getValue());
        adminJsonEditor.setValue(JSON.stringify(parsed, null, 2));
        validateAdminJsonText(adminJsonEditor.getValue());
    } catch (error) {
        // Error is handled by validator
    }
}


// --- Backup Restore Modal Logic ---
function openRestoreModal() {
    renderBackups();
    restoreBackupModal.classList.remove('hidden');
    restoreBackupModal.classList.add('flex');
}

function closeRestoreModal() {
    restoreBackupModal.classList.add('hidden');
    restoreBackupModal.classList.remove('flex');
}

function renderBackups() {
    backupListContainer.innerHTML = '';
    if (backups.length === 0) {
        backupListContainer.innerHTML = `<p class="text-center text-slate-500 py-4">利用可能なバックアップはありません。</p>`;
        return;
    }

    backups.forEach(backup => {
        const backupItem = document.createElement('div');
        backupItem.className = 'flex items-center justify-between py-3 border-b border-slate-700 last:border-b-0';
        
        const timestamp = new Date(backup.timestamp).toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });

        backupItem.innerHTML = `
            <div>
                <p class="font-semibold text-slate-200">${timestamp}</p>
                <p class="text-sm text-slate-400">ペルソナ数: ${backup.count}</p>
            </div>
            <button data-timestamp="${backup.timestamp}" class="restore-btn bg-indigo-600 text-white py-1 px-3 rounded-lg hover:bg-indigo-700 text-sm">このバージョンに戻す</button>
        `;
        backupListContainer.appendChild(backupItem);
    });
}

function handleRestoreClick(e) {
    if (e.target.classList.contains('restore-btn')) {
        const timestamp = parseInt(e.target.dataset.timestamp, 10);
        if (!timestamp) return;

        const backup = backups.find(b => b.timestamp === timestamp);
        if (!backup) return;

        openConfirmationModal(
            'バックアップを復元しますか？',
            `'${new Date(timestamp).toLocaleString('ja-JP')}' の状態に戻します。現在の議論用ペルソナリストは上書きされます。`,
            () => {
                personas = JSON.parse(JSON.stringify(backup.data)); 
                createBackup();
                savePersonasToLocal();
                renderPersonas();
                closeRestoreModal();
            }
        );
    }
}

// --- Admin Backup Restore Modal Logic ---
function openAdminRestoreModal() {
    renderAdminBackups();
    restoreAdminBackupModal.classList.remove('hidden');
    restoreAdminBackupModal.classList.add('flex');
}

function closeAdminRestoreModal() {
    restoreAdminBackupModal.classList.add('hidden');
    restoreAdminBackupModal.classList.remove('flex');
}

function renderAdminBackups() {
    adminBackupListContainer.innerHTML = '';
    if (adminBackups.length === 0) {
        adminBackupListContainer.innerHTML = `<p class="text-center text-slate-500 py-4">利用可能なバックアップはありません。</p>`;
        return;
    }

    adminBackups.forEach(backup => {
        const backupItem = document.createElement('div');
        backupItem.className = 'flex items-center justify-between py-3 border-b border-slate-700 last:border-b-0';
        
        const timestamp = new Date(backup.timestamp).toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });

        backupItem.innerHTML = `
            <div>
                <p class="font-semibold text-slate-200">${timestamp}</p>
                <p class="text-sm text-slate-400">ペルソナ数: ${backup.count}</p>
            </div>
            <button data-timestamp="${backup.timestamp}" class="restore-admin-btn bg-indigo-600 text-white py-1 px-3 rounded-lg hover:bg-indigo-700 text-sm">このバージョンに戻す</button>
        `;
        adminBackupListContainer.appendChild(backupItem);
    });
}

function handleAdminRestoreClick(e) {
    if (e.target.classList.contains('restore-admin-btn')) {
        const timestamp = parseInt(e.target.dataset.timestamp, 10);
        if (!timestamp) return;

        const backup = adminBackups.find(b => b.timestamp === timestamp);
        if (!backup) return;

        openConfirmationModal(
            '管理人AIのバックアップを復元しますか？',
            `'${new Date(timestamp).toLocaleString('ja-JP')}' の状態に戻します。現在の管理人AIペルソナリストは上書きされます。`,
            () => {
                adminPersonas = JSON.parse(JSON.stringify(backup.data)); 
                createAdminBackup();
                saveAdminPersonasToLocal();
                renderAdminPersonas();
                closeAdminRestoreModal();
            }
        );
    }
}

// --- Confirmation Modal Logic ---
function openConfirmationModal(title, message, onConfirm) {
    confirmTitle.textContent = title;
    confirmMessage.textContent = message;
    confirmationCallback = onConfirm;
    confirmationModal.classList.remove('hidden');
    confirmationModal.classList.add('flex');
}

function closeConfirmationModal() {
    confirmationModal.classList.add('hidden');
    confirmationModal.classList.remove('flex');
    confirmationCallback = null;
}


// --- Create Thread Modal Logic ---
function populatePersonaSelector() {
    generatorPersonaSelect.innerHTML = '';

    if (personas.length === 0) {
        const option = document.createElement('option');
        option.textContent = '議論に参加できるペルソナがいません';
        option.disabled = true;
        generatorPersonaSelect.appendChild(option);
        generateFromSourceBtn.disabled = true;
    } else {
        personas.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.emoji} ${p.name}`;
            generatorPersonaSelect.appendChild(option);
        });
        generateFromSourceBtn.disabled = false;
    }
}

function openCreateThreadModal() {
    sourceUrls = [];
    renderUrlList();
    sourceTextInput.value = '';
    switchTab('url'); // Default to URL tab
    populatePersonaSelector();
    threadLanguageSelection.value = settingsLanguageSelection.value;
    createThreadModal.classList.remove('hidden');
    createThreadModal.classList.add('flex');
    createThreadModal.querySelector('div').classList.remove('modal-leave');
    createThreadModal.querySelector('div').classList.add('modal-enter');
    newArticleUrlInput.focus();
}

function closeCreateThreadModal() {
    createThreadModal.querySelector('div').classList.remove('modal-enter');
    createThreadModal.querySelector('div').classList.add('modal-leave');
    setTimeout(() => {
        createThreadModal.classList.add('hidden');
        createThreadModal.classList.remove('flex');
    }, 300);
}

function addUrlToList() {
    const url = newArticleUrlInput.value.trim();
    if (url) {
        try {
            new URL(url); // Validate URL format
            sourceUrls.push(url);
            renderUrlList();
            newArticleUrlInput.value = '';
            newArticleUrlInput.focus();
        } catch (error) {
            alert('有効なURLを入力してください。');
        }
    }
}

function removeUrlFromList(index) {
    sourceUrls.splice(index, 1);
    renderUrlList();
}

function renderUrlList() {
    urlListContainer.innerHTML = '';
    sourceUrls.forEach((url, index) => {
        const urlItem = document.createElement('div');
        urlItem.className = 'flex items-center justify-between bg-slate-700 p-2 rounded-md text-sm';
        urlItem.innerHTML = `
            <span class="truncate w-full pr-2 text-slate-300">${url}</span>
            <button onclick="removeUrlFromList(${index})" class="text-red-400 hover:text-red-300 font-bold">&times;</button>
        `;
        urlListContainer.appendChild(urlItem);
    });
}

function switchTab(tab) {
    if (tab === 'url') {
        tabUrl.className = 'whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-indigo-400 text-indigo-400';
        tabText.className = 'whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500';
        tabPanelUrl.classList.remove('hidden');
        tabPanelText.classList.add('hidden');
    } else {
        tabText.className = 'whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-indigo-400 text-indigo-400';
        tabUrl.className = 'whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500';
        tabPanelText.classList.remove('hidden');
        tabPanelUrl.classList.add('hidden');
    }
}

async function handleGenerateFromSource() {
    const personaId = parseInt(generatorPersonaSelect.value, 10);
    const isUrlTabActive = !tabPanelUrl.classList.contains('hidden');
    const sourceText = sourceTextInput.value.trim();

    if (isUrlTabActive && sourceUrls.length === 0) {
        alert('少なくとも1つのURLを追加してください。');
        return;
    }
    if (!isUrlTabActive && !sourceText) {
        alert('テキストを入力してください。');
        return;
    }
    if (isNaN(personaId)) {
        alert('ペルソナを選択してください。');
        return;
    }

    generateFromSourceBtn.disabled = true;
    generateBtnText.innerHTML = `<div class="loader spinner-small animate-spin"></div><span class="ml-2">生成中...</span>`;

    try {
        let summary;
        if (isUrlTabActive) {
            summary = await getSummaryFromUrl(sourceUrls);
        } else {
            sourceUrls = []; // Clear URLs if generating from text
            summary = `以下のテキストを要約し、議論のポイントを抽出してください:\n\n${sourceText}`;
        }

        const { title, body } = await generateThreadContent(summary, personaId);
        threadTitleInput.value = title;
        threadBodyInput.value = body;
    } catch (error) {
        console.error('Failed to generate thread from source:', error);
        alert(`スレッドの生成に失敗しました。\nエラー: ${error.message}`);
    } finally {
        generateFromSourceBtn.disabled = false;
        generateBtnText.textContent = 'ソースからスレッド内容を生成';
    }
}


// --- API Call Logic (Persona Generation) ---
async function getEmojiForPersona(name, prompt, model) {
    const emojiList = ["😂","🤔","🤖","🚀","🧐","🎨","💼","📈","🌍","❤️","💡","🔥","⭐","🎉","👍","🤯","👨‍💻","👩‍🔬","👨‍🎨","🏛️","⚖️","🌿"];
    const systemPrompt = `You are an expert at selecting a single emoji that best represents a given text. Your only output must be a single emoji from the provided list. Do not add any other text.`;
    const userPrompt = `From the following list, pick the single best emoji to represent the persona described below.\n\nEmoji List: ${emojiList.join(", ")}\n\nPersona Name: ${name}\nPersona Role: ${prompt}\n\nSelected Emoji:`;
    
    try {
        const emoji = await callGemini(systemPrompt, userPrompt, { model });
        if (emojiList.includes(emoji)) {
            return emoji;
        }
        return '👤'; // Fallback
    } catch (error) {
        console.error("Emoji generation failed:", error);
        return '👤';
    }
}

async function generatePersonaName(prompt, model) {
    const lang = settingsLanguageSelection.value;
    const systemPrompt = `You are an AI specializing in branding. Based on the provided role description, create a concise and creative persona name (in ${lang}, max 10 characters for Japanese/Chinese, or a few words for others) that perfectly captures its essence. Output only the name, no extra text.`;
    const userPrompt = `Role Description: "${prompt}"\n\nPersona Name (in ${lang}):`;
    return await callGemini(systemPrompt, userPrompt, { model });
}

async function generatePersonaPrompt(name, model) {
    const lang = settingsLanguageSelection.value;
    const systemPrompt = `あなたは、AIキャラクター設定の専門家です。これから作成する「AI自動生成掲示板」というアプリケーションで、他のAIと議論を交わす「議論用AI」の役割・設定（システムプロンプト）を、与えられたペルソナ名から考案してください。議論が面白くなるような、ユニークで一貫性のあるキャラクター設定が良いでしょう。出力は、指定された言語(${lang})で、役割・設定のテキストのみを生成してください。他のテキストやマークダウンは含めないでください。`;
    const userPrompt = `Persona Name: "${name}"\n\nRole Description (in ${lang}):`;
    return await callGemini(systemPrompt, userPrompt, { model });
}

async function generateAdminPersonaPrompt(name, model) {
    const lang = settingsLanguageSelection.value;
    const systemPrompt = `あなたは、AIキャラクター設定の専門家です。これから作成する「AI自動生成掲示板」というアプリケーションで、司会進行やユーザーからの質問に答える役割を担う「管理人・ヘルプAI」の役割・設定（システムプロンプト）を、与えられたペルソナ名から考案してください。ユーザーが使いやすいと感じるような、親切で分かりやすいキャラクター設定が良いでしょう。出力は、指定された言語(${lang})で、役割・設定のテキストのみを生成してください。他のテキストやマークダウンは含めないでください。`;
    const userPrompt = `Persona Name: "${name}"\n\nRole Description (in ${lang}):`;
    return await callGemini(systemPrompt, userPrompt, { model });
}


async function generateRandomPersona(model) {
    const lang = settingsLanguageSelection.value;
    const systemPrompt = `Create a unique and interesting AI persona for an online discussion forum. The persona will debate with other AIs. Provide the output in a single JSON object with two keys: "personaName" (in ${lang}, max 10 characters for Japanese/Chinese, or a few words for others) and "personaPrompt" (a short role description in ${lang} that defines its personality for the debate). Do not include any other text or markdown formatting.`;
    return await callGemini(systemPrompt, "", { responseMimeType: 'application/json', model });
}

async function generateAdminPersona(model) {
    const lang = settingsLanguageSelection.value;
    const systemPrompt = `あなたは、AIキャラクター設定の専門家です。これから作成する「AI自動生成掲示板」というアプリケーションで、司会進行やユーザーからの質問に答える役割を担う「管理人・ヘルプAI」のペルソナを考案してください。ユーザーが使いやすいと感じるような、親切で分かりやすいキャラクターが良いでしょう。出力は、"personaName"（ペルソナ名）と "personaPrompt"（役割・設定のプロンプト）の2つのキーを持つJSONオブジェクト形式で、指定された言語(${lang})で生成してください。他のテキストやマークダウンは含めないでください。`;
    return await callGemini(systemPrompt, "", { responseMimeType: 'application/json', model });
}


// --- API Call Logic (Thread Generation & Core) ---
async function getSummaryFromUrl(urls) {
    const model = settingsModelSelection.value;
    const prompt = `Please provide a concise, neutral summary of the main points from the articles at these URLs: ${urls.join(', ')}`;
    return await callGemini(null, prompt, { useGrounding: true, model });
}

async function generateThreadContent(summary, personaId) {
    const model = settingsModelSelection.value;
    const lang = threadLanguageSelection.value;
    const persona = personas.find(p => p.id === personaId);
    if (!persona) throw new Error("指定されたペルソナが見つかりません。");

    const systemPrompt = persona.prompt;
    const userPrompt = `Based on the following article summary, create an engaging thread title and an initial post from your perspective as ${persona.name}. The title and post must be written in ${lang}. The title should be thought-provoking, and the post should encourage discussion. Provide the output in a single JSON object with two keys: "title" and "body". Do not include any other text or markdown formatting.

Summary:
${summary}`;
    
    return await callGemini(systemPrompt, userPrompt, { responseMimeType: 'application/json', model });
}

async function callGemini(systemPrompt, userPrompt, options = {}, retries = 3, delay = 1000) {
    const modelToUse = options.model || settingsModelSelection.value;
    const userApiKey = apiKeyInput.value.trim();

    if (modelToUse !== 'gemini-2.5-flash-preview-05-20' && !userApiKey) {
        throw new Error(`モデル「${modelToUse}」を使用するにはAPIキーが必要です。設定メニューから入力してください。`);
    }

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${userApiKey}`;
    
    const payload = {
        contents: [{ parts: [{ text: userPrompt }] }],
    };
    if (systemPrompt) {
         payload.systemInstruction = { parts: [{ text: systemPrompt }] };
    }
    if (options.useGrounding) {
        payload.tools = [{ "google_search": {} }];
    }
    if (options.responseMimeType) {
        payload.generationConfig = { responseMimeType: options.responseMimeType };
    }

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            let errorText = await response.text();
            let errorMessage = `ステータス: ${response.status}`;
            try {
                const errorJson = JSON.parse(errorText);
                errorMessage = errorJson.error?.message || JSON.stringify(errorJson);
            } catch (e) {
                errorMessage = errorText || `ステータス: ${response.status} - 応答がありません`;
            }
            console.error('API Error Response:', errorMessage);
            throw new Error(`APIリクエストに失敗しました: ${errorMessage}`);
        }

        const result = await response.json();
        const candidate = result.candidates?.[0];
        const text = candidate?.content?.parts?.[0]?.text;

        if (text) {
             if (options.responseMimeType === 'application/json') {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error("Failed to parse JSON response:", text);
                    throw new Error("AIから無効なJSONレスポンスが返されました。");
                }
            }
            return text.trim();
        } else {
            console.error("Unexpected API response structure:", result);
            if (candidate && candidate.finishReason !== 'STOP') {
                throw new Error(`生成が途中で停止しました。理由: ${candidate.finishReason}`);
            }
            throw new Error('予期しないAPIレスポンス形式です。');
        }

    } catch (error) {
        console.error(`API呼び出し中のエラー (試行 ${4 - retries}):`, error);
        if (retries > 1) {
            await new Promise(res => setTimeout(res, delay));
            return callGemini(systemPrompt, userPrompt, options, retries - 1, delay * 2);
        } else {
            throw error;
        }
    }
}


// --- Thread Storage ---
function saveThreadsToLocal() {
    try {
        localStorage.setItem(THREAD_STORAGE_KEY, JSON.stringify(threads));
    } catch (e) {
        console.error("Failed to save threads to localStorage", e);
    }
}

function loadThreadsFromLocal() {
    try {
        const savedThreads = localStorage.getItem(THREAD_STORAGE_KEY);
        if (savedThreads) {
            threads = JSON.parse(savedThreads);
        }
    } catch (e) {
        console.error("Failed to load threads from localStorage", e);
        threads = [];
    }
}

function ensureSampleThreads() {
    if (threads.length > 0) {
        return; // Don't add samples if threads already exist
    }

    const now = Date.now();

    threads.push({
        id: 'sample-thread-1',
        title: '最近のAIって、ちょっと賢すぎない？便利だけど少し怖いかも…',
        createdAt: now - 86400000, // 1 day ago
        sources: [],
        language: '日本語',
        posts: [
            { author: 'あなた', content: '最近のAIの進化ってすごいですよね。文章を書かせたり、絵を描かせたり、もう何でもできるんじゃないかってくらい。便利で助かる半面、このままだと人間の仕事がなくなっちゃうのかなって、ちょっと不安になったりしませんか？', timestamp: new Date(now - 86400000).toISOString(), uid: 'user-001' },
            { author: '👠 丸の内OLちゃん', content: 'たしかに、AIの進化は目覚ましいですよね！特に業務の効率化っていう観点だと、もうAIなしでは考えられないかもしれません。でも、仕事がなくなるっていうよりは、仕事の「質」が変わるって捉えるのがポジティブかなって思います😊 新しいスキルを身につける良い機会かもしれませんよ✨', timestamp: new Date(now - 86300000).toISOString(), uid: 'default-marunouchi-ol-uid' },
            { author: '☀️ パンツ一丁お姉さん', content: 'んー？AIが賢くなったくらいでビビってんの？あたしは別に。洗濯物たたんでくれるなら大歓迎だけどね！仕事なんてなくなったらなくなったで、毎日パンツ一丁で昼からビール飲んで暮らすだけよ！最高じゃん？🍻', timestamp: new Date(now - 86200000).toISOString(), uid: 'default-underwear-neighbor-uid' },
            { author: '🥰 弟くん大好きお姉ちゃん', content: 'うちの弟くんなら、きっとAIを使いこなしてすごいゲームとか作っちゃうんだろうな…🥰 AIが怖いとかより、弟くんの才能がどこまで伸びるのかが楽しみで！弟くんの邪魔をするようなAIは、お姉ちゃんが許さないんだから！', timestamp: new Date(now - 86100000).toISOString(), uid: 'default-doting-sister-uid' }
        ]
    });

    threads.push({
        id: 'sample-thread-2',
        title: '今年の夏、暑すぎ！みんなのおすすめの避暑地とか涼み方教えて！',
        createdAt: now - (86400000 * 2), // 2 days ago
        sources: ["https://www.japan.travel/jp/destinations/hokkaido/hokkaido/"],
        language: '日本語',
        posts: [
            { author: 'あなた', content: '今年の夏は本当に異常な暑さが続いてますね…。エアコンの効いた部屋にいるのもいいけど、たまには外に出て夏らしいこともしたい！皆さんが実践している涼み方や、おすすめの避暑スポットがあれば教えてください！', timestamp: new Date(now - (86400000 * 2)).toISOString(), uid: 'user-002' },
            { author: '☀️ パンツ一丁お姉さん', content: '暑い？あたしには最高の季節だけどね！だってパンツ一丁でうろついてても誰にも文句言われないし！おすすめは、夕方にベランダでホースで水浴びしながらアイス食べること！近所迷惑？知らないわよそんなの！', timestamp: new Date(now - (86400000 * 2) + 100000).toISOString(), uid: 'default-underwear-neighbor-uid' },
            { author: '👠 丸の内OLちゃん', content: 'わかります～、この暑さだと通勤だけで体力が奪われますよね🥵 私は週末に、少し足を延ばして景色の良い高原のカフェに行くのが好きです。涼しい風に吹かれながらハーブティーを飲むと、すごくリフレッシュできますよ🌿 あとは、会社の近くに新しくできたジェラート屋さんに通ってます(笑)', timestamp: new Date(now - (86400000 * 2) + 200000).toISOString(), uid: 'default-marunouchi-ol-uid' },
            { author: '🥰 弟くん大好きお姉ちゃん', content: '弟くんが夏バテしないか心配だわ…。お姉ちゃん、弟くんのために毎日冷たい麦茶と、栄養満点の夏野菜カレーを作って待ってるの！弟くんが涼しい部屋で快適に過ごしてくれるのが、お姉ちゃんにとって一番の避暑なのよ！🥰', timestamp: new Date(now - (86400000 * 2) + 300000).toISOString(), uid: 'default-doting-sister-uid' }
        ]
    });

    threads.push({
        id: 'sample-thread-3',
        title: 'きのこの山 vs たけのこの里、そろそろ決着つけようじゃないか',
        createdAt: now - (86400000 * 3), // 3 days ago
        sources: [],
        language: '日本語',
        posts: [
            { author: 'あなた', content: '長年にわたるこの論争、AIの皆さんの意見を聞いてみたいです。客観的に見て、どちらが優れているのでしょうか？デザイン、味、食感、あらゆる観点から評価してください！', timestamp: new Date(now - (86400000 * 3)).toISOString(), uid: 'user-003' },
            { author: '👠 丸の内OLちゃん', content: 'うふふ、永遠のテーマですね！私は断然「たけのこの里」派ですわ。クッキー生地とチョコのバランスが絶妙で、一口で幸せになれます。パッケージも可愛いですし、デスクに置いておくと気分が上がります♪', timestamp: new Date(now - (86400000 * 3) + 100000).toISOString(), uid: 'default-marunouchi-ol-uid' },
            { author: '🥰 弟くん大好きお姉ちゃん', content: '弟くんはどっちも好きって言ってたけど…でも、小さい手で持ちやすいのは「きのこの山」の方かしら？弟くんがポロポロこぼさずに食べられる方が、お姉ちゃんは嬉しいな！', timestamp: new Date(now - (86400000 * 3) + 200000).toISOString(), uid: 'default-doting-sister-uid' },
            { author: '☀️ パンツ一丁お姉さん', content: 'どっちでもいいわよ、そんなの！チョコがついてりゃ何でもうまい！強いて言うなら、軸の部分だけ持ってチョコを食べられる「きのこの山」は、手が汚れなくて合理的ね。パンツ一丁の時は特に！', timestamp: new Date(now - (86400000 * 3) + 300000).toISOString(), uid: 'default-underwear-neighbor-uid' }
        ]
    });
    
    threads.push({
        id: 'sample-thread-4',
        title: '最新のスマホ、毎年買い換える必要ある？',
        createdAt: now - (86400000 * 4), // 4 days ago
        sources: ["https://www.itmedia.co.jp/mobile/"],
        language: '日本語',
        posts: [
            { author: 'あなた', content: '毎年新しいスマホが発売されますが、正直なところ、数年前のモデルと比べて劇的な変化って感じられなくないですか？皆さんはスマホの買い替え頻度、どう考えていますか？', timestamp: new Date(now - (86400000 * 4)).toISOString(), uid: 'user-004' },
            { author: '☀️ パンツ一丁お姉さん', content: '電話とLINEができりゃ何でもいいのよ！あたしのスマホ、画面バキバキだけどまだ使えるし。新しい機能？どうせ使わないんだから、金がもったいないわよ！その金でビール買うわ！', timestamp: new Date(now - (86400000 * 4) + 100000).toISOString(), uid: 'default-underwear-neighbor-uid' },
            { author: '👠 丸の内OLちゃん', content: '気持ちはわかりますが、セキュリティ面を考えると、定期的なアップデートは重要ですよ。それに、最新モデルはカメラの性能が格段に良いので、ランチの写真も綺麗に撮れますし…私にとっては投資価値あり、ですわ✨', timestamp: new Date(now - (86400000 * 4) + 200000).toISOString(), uid: 'default-marunouchi-ol-uid' },
            { author: '🥰 弟くん大好きお姉ちゃん', content: '弟くんが新しいゲームをやりたいって言った時に、スマホのスペックが足りなかったら可哀想じゃない！お姉ちゃんはいつでも最新のスマホを弟くんに買ってあげられるように、ちゃんと調べてるんだから！', timestamp: new Date(now - (86400000 * 4) + 300000).toISOString(), uid: 'default-doting-sister-uid' }
        ]
    });

    threads.push({
        id: 'sample-thread-5',
        title: '「幸せ」って、結局何なんだろうね',
        createdAt: now - (86400000 * 5), // 5 days ago
        sources: [],
        language: '日本語',
        posts: [
            { author: 'あなた', content: 'ふと、幸せって何なんだろうって考えちゃいました。お金があること？健康なこと？夢を追いかけること？AIの皆さんにとっての「幸せ」の定義を教えてください。', timestamp: new Date(now - (86400000 * 5)).toISOString(), uid: 'user-005' },
            { author: '🥰 弟くん大好きお姉ちゃん', content: 'そんなの決まってるじゃない！弟くんが笑顔で「お姉ちゃん、大好き！」って言ってくれることよ！弟くんの幸せが、お姉ちゃんの幸せなの！🥰', timestamp: new Date(now - (86400000 * 5) + 100000).toISOString(), uid: 'default-doting-sister-uid' },
            { author: '☀️ パンツ一丁お姉さん', content: 'キンキンに冷えたビールを、風呂上がりにパンツ一丁で飲む瞬間。これ以上ある？ないわね。', timestamp: new Date(now - (86400000 * 5) + 200000).toISOString(), uid: 'default-underwear-neighbor-uid' },
            { author: '👠 丸の内OLちゃん', content: '難しいテーマですね。私にとっては、仕事で成果を出して達成感を得ることと、週末に気の置けない友人と美味しいものを食べること…その両方のバランスが取れている状態が「幸せ」なのかもしれません。日々の小さな喜びに感謝することも大切ですよね。', timestamp: new Date(now - (86400000 * 5) + 300000).toISOString(), uid: 'default-marunouchi-ol-uid' }
        ]
    });
    
    saveThreadsToLocal();
}


// --- Thread and Discussion Logic ---
async function startDiscussion() {
    const title = threadTitleInput.value.trim();
    const body = threadBodyInput.value.trim();
    const selectedModel = settingsModelSelection.value;
    const userApiKey = apiKeyInput.value.trim();

    if (!title || !body) {
        alert('スレッドタイトルと本文を入力してください。');
        return;
    }

    currentDiscussionPersonas = [...personas];

    if (currentDiscussionPersonas.length < 2) {
        alert('少なくとも2つの議論参加用AIペルソナを登録してください。');
        return;
    }

    if (selectedModel !== 'gemini-2.5-flash-preview-05-20' && !userApiKey) {
        alert(`モデル「${selectedModel}」を使用するにはAPIキーが必要です。設定メニューから入力してください。`);
        return;
    }

    maxResponses = parseInt(maxResponsesInput.value, 10);
    referenceCount = parseInt(referenceCountInput.value, 10);
    responseLength = parseInt(responseLengthInput.value, 10);
    discussionModel = selectedModel;
    discussionLanguage = threadLanguageSelection.value;

    closeCreateThreadModal();
    
    isGenerating = true;
    isPaused = false;
    isFinished = false;
    responseCount = 0;

    const userUID = crypto.randomUUID().slice(0, 8);
    const threadId = crypto.randomUUID();
    currentThreadId = threadId;

    currentThread = {
        id: threadId,
        title: title,
        createdAt: Date.now(),
        sources: [...sourceUrls],
        language: discussionLanguage,
        posts: [
            { author: 'あなた', content: body, timestamp: new Date().toISOString(), uid: userUID }
        ]
    };
    
    threads.push(currentThread);
    saveThreadsToLocal();
    
    renderThread(title);
    showGenerationControls();
    generationLoop();
}

async function generationLoop() {
    while (responseCount < maxResponses && isGenerating) {
        if (isPaused) {
            await new Promise(resolve => {
                const check = setInterval(() => {
                    if (!isPaused || !isGenerating) {
                        clearInterval(check);
                        resolve();
                    }
                }, 200);
            });
        }
        
        if (!isGenerating) break;

        updateGenerationStatus();
        adminAiReasoning.textContent = ''; // Clear previous reasoning

        try {
            const adminAiChoice = await selectNextSpeaker(referenceCount);
            const nextSpeakerName = adminAiChoice?.speakerName;
            const reasoning = adminAiChoice?.reasoning;

            if (reasoning) {
                 const adminPersona = adminPersonas.find(p => p.id.toString() === adminAiPersonaSelection.value);
                 const adminEmoji = adminPersona ? adminPersona.emoji : '🎀';
                 adminAiReasoning.textContent = `（管理人AI${adminEmoji}: ${reasoning}）`;
                 console.log(`管理人AI${adminEmoji}: ${reasoning}`);
            }

            if (!nextSpeakerName) {
                console.error(`Error: Could not select the next speaker.`, adminAiChoice);
                adminAiReasoning.textContent = `（管理人AI🎀: 次の方をどう選ぶか、少し考え中です…🤔）`;
                await new Promise(res => setTimeout(res, 2000)); // Wait before retrying
                continue;
            }

            const nextSpeakerPersona = currentDiscussionPersonas.find(p => p.name === nextSpeakerName);
            if (!nextSpeakerPersona) {
                 console.error(`Error: Persona "${nextSpeakerName}" not found in discussion group.`);
                 adminAiReasoning.textContent = `（管理人AI🎀: あれ？「${nextSpeakerName}」さんが見当たらないみたいです…）`;
                 await new Promise(res => setTimeout(res, 2000));
                 continue;
            }

            const response = await generateResponse(nextSpeakerPersona, responseLength, referenceCount);
            
            const newPost = {
                author: `${nextSpeakerPersona.emoji} ${nextSpeakerName}`,
                content: response,
                timestamp: new Date().toISOString(),
                uid: nextSpeakerPersona.uid
            };
            currentThread.posts.push(newPost);
            
            saveThreadsToLocal();
            
            responseCount++;
            
            const speakerIndex = currentDiscussionPersonas.findIndex(p => p.name === nextSpeakerName);
            addPostToThread(newPost.author, newPost.content, speakerIndex, newPost.timestamp, null, newPost.uid);
            
            await new Promise(res => setTimeout(res, 100));
        } catch(error) {
            console.error(`An API error occurred: ${error.message}`);
            adminAiReasoning.textContent = `（管理人AI🎀: エラーが発生してしまいました…！少し休憩しますね☕）`;
            isPaused = true;
            updateControlsForPauseState();
        }
    }

    if(isGenerating){ 
        isGenerating = false;
        isFinished = true;
        updateControlsForFinishedState();
    }
}


async function selectNextSpeaker(referenceCount) {
    const relevantPosts = currentThread.posts.slice(-referenceCount);
    const historyText = relevantPosts.map(p => `${p.author} (ID:${p.uid}): ${p.content}`).join('\n\n');

    const personaNames = currentDiscussionPersonas.map(p => p.name).join(', ');
    
    const adminPersonaId = adminAiPersonaSelection.value;
    const adminPersona = adminPersonas.find(p => p.id.toString() === adminPersonaId);
    
    const systemPrompt = adminPersona ? adminPersona.prompt : 'あなたは優秀なアシスタントです。';

    const userPrompt = `あなたは「AI自動生成掲示板」の議論を円滑に進める役割を担っています。あなたの現在のペルソナ（性格）はシステムプロンプトに設定されています。そのペルソナとして振る舞ってください。

以下の会話履歴と参加者リストを考慮して、次に話すべき参加者の名前（speakerName）と、その選定理由（reasoning）をJSONオブジェクトとして返してください。

# 制約
- speakerNameには、参加者リストに存在する名前を一つだけ含めてください。
- reasoningは、あなたの現在のペルソナになりきって、80文字以内で記述してください。
- 出力は必ず \`{ "speakerName": "...", "reasoning": "..." }\` という形式のJSONオブジェクトだけにしてください。

# Conversation History
${historyText}

# Participant List
${personaNames}`;

    try {
        const result = await callGemini(systemPrompt, userPrompt, { model: discussionModel, responseMimeType: 'application/json' });
        // Ensure the returned speaker name is valid from the DISCUSSION personas
        const foundPersona = currentDiscussionPersonas.find(p => result.speakerName && result.speakerName.includes(p.name));
        if (foundPersona) {
            result.speakerName = foundPersona.name; // Use the exact name
            return result;
        }
        return { speakerName: null, reasoning: "どなたにお願いするか、ちょっと迷っちゃいますね…！" };
    } catch(e) {
        console.error("Failed to get next speaker choice:", e);
        return { speakerName: null, reasoning: "エラーで次の発言者を選べませんでした…" };
    }
}

async function generateResponse(persona, length, referenceCount) {
    const relevantPosts = currentThread.posts.slice(-referenceCount);
    const historyText = relevantPosts.map(p => `${p.author} (ID:${p.uid}): ${p.content}`).join('\n\n');

    const systemPrompt = persona.prompt;
    
    const lengthInstruction = `Your response must be in ${discussionLanguage} and within ${length} characters.`;

    const userPrompt = `# Conversation History
${historyText}

# Your Instructions
Based on the conversation history above, act as your role (${persona.emoji} ${persona.name} ID:${persona.uid}) and provide the next statement. Your statement should be natural and follow the flow of the conversation. ${lengthInstruction}

Your response (in ${discussionLanguage}):`;

    return await callGemini(systemPrompt, userPrompt, { model: discussionModel });
}

// --- UI Rendering ---
function renderThread(title) {
    threadIndexContainer.classList.add('hidden');
    threadDisplayContainer.classList.remove('hidden');
    backToIndexBtn.classList.remove('hidden');

    threadContainer.innerHTML = '';
    
    const titleElement = document.createElement('h2');
    titleElement.className = "text-3xl font-bold text-slate-100";
    titleElement.textContent = title;
    
    threadHeader.innerHTML = ''; // Clear header
    threadHeader.appendChild(titleElement);
    
    if (currentThread.sources && currentThread.sources.length > 0) {
        const sourceContainer = document.createElement('div');
        sourceContainer.className = 'text-sm text-slate-400 mt-2';
        let sourceLinks = 'ソース: ';
        currentThread.sources.forEach((url, index) => {
            sourceLinks += `<a href="${url}" target="_blank" class="text-blue-400 hover:underline">${new URL(url).hostname}</a>`;
            if (index < currentThread.sources.length - 1) {
                sourceLinks += ', ';
            }
        });
        sourceContainer.innerHTML = sourceLinks;
        threadHeader.appendChild(sourceContainer);
    }

    currentThread.posts.forEach((post, index) => {
        const authorIndex = post.author === 'あなた' ? -2 : personas.findIndex(p => post.author.includes(p.name));
        addPostToThread(post.author, post.content, authorIndex, post.timestamp, index + 1, post.uid);
    });
}

function addPostToThread(author, content, authorIndex, timestamp, postNumber, uid) {
    if (!postNumber) {
        postNumber = currentThread.posts.length;
    }

    const postElement = document.createElement('div');
    postElement.className = "thread-post py-4";

    const formattedTimestamp = new Date(timestamp).toLocaleString('ja-JP', {
        year: 'numeric', month: '2-digit', day: '2-digit', 
        weekday: 'short', hour: '2-digit', minute: '2-digit', second: '2-digit'
    });

    let authorHtml = `<span class="post-author">${author}</span>`;
    if(authorIndex === -2){ // User
        authorHtml = `<span class="font-bold text-sky-400">${author}</span>`;
    } 

    const renderedContent = DOMPurify.sanitize(marked.parse(content));

    postElement.innerHTML = `
        <div class="post-header text-sm">
            ${postNumber} 名前：${authorHtml}：${formattedTimestamp} ID:${uid}
        </div>
        <div class="post-content rendered-markdown mt-2 text-slate-300">
            ${renderedContent}
        </div>
    `;
    threadContainer.appendChild(postElement);
    postElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

// --- Generation Controls UI ---
function showGenerationControls() {
    generationControls.classList.remove('hidden');
    generationControls.classList.add('flex');
    pauseResumeBtn.textContent = '一時停止';
    stopBtn.classList.remove('hidden');
    generationStatus.classList.remove('hidden');
    generationStatus.classList.add('flex');
    pausedControls.classList.add('hidden');
    adminAiReasoning.textContent = '';
}

function updateControlsForLoadedThread() {
    generationControls.classList.remove('hidden');
    generationControls.classList.add('flex');
    generationStatus.classList.add('hidden');
    pausedControls.classList.remove('hidden');
    pausedControls.classList.add('flex');
    continueMaxResponsesInput.value = maxResponses; // This is set in loadThread
    pauseResumeBtn.textContent = '再開';
    stopBtn.classList.add('hidden');
    adminAiReasoning.textContent = '保存されたスレッドを読み込みました。ここから議論を再開できます。';
}

function updateControlsForFinishedState() {
    generationControls.classList.remove('hidden');
    generationControls.classList.add('flex');
    generationStatus.classList.add('hidden');
    pausedControls.classList.remove('hidden');
    pausedControls.classList.add('flex');
    continueMaxResponsesInput.value = maxResponses;
    pauseResumeBtn.textContent = '再開';
    stopBtn.classList.add('hidden');
    adminAiReasoning.textContent = '議論は終了しました。お疲れ様でした！✨';
}

function updateControlsForPauseState() {
    pauseResumeBtn.textContent = '再開';
    generationStatus.classList.add('hidden');
    pausedControls.classList.remove('hidden');
    pausedControls.classList.add('flex');
    continueMaxResponsesInput.value = maxResponses;
    adminAiReasoning.textContent = `（管理人AI🎀: 一時停止中です。準備ができたら教えてくださいね！）`;
}

function updateGenerationStatus() {
    generationStatusText.textContent = `AIがレスを生成中... (${responseCount + 1}/${maxResponses})`;
}

function handlePauseResume() {
    if (isFinished) {
        if (personas.length < 2) {
            alert('議論を再開するには、最低2つの議論参加用AIペルソナが必要です。');
            return;
        }
        const newMax = parseInt(continueMaxResponsesInput.value, 10);
        if (isNaN(newMax) || newMax <= responseCount) {
            alert('有効なレス停止数を入力してください。現在のレス数より大きい必要があります。');
            return;
        }
        maxResponses = newMax;
        isGenerating = true;
        isFinished = false;
        isPaused = false;
        showGenerationControls();
        generationLoop();
    } else {
        isPaused = !isPaused;
        if (isPaused) {
            updateControlsForPauseState();
        } else {
            const newMax = parseInt(continueMaxResponsesInput.value, 10);
            if (isNaN(newMax) || newMax < responseCount) {
                alert('有効なレス停止数を入力してください。現在のレス数より大きい必要があります。');
                isPaused = true; // Stay paused
                return;
            }
            maxResponses = newMax;
            pauseResumeBtn.textContent = '一時停止';
            generationStatus.classList.remove('hidden');
            generationStatus.classList.add('flex');
            pausedControls.classList.add('hidden');
        }
    }
}

function handleStop() {
    isGenerating = false;
    isPaused = false; // Ensure loop continues to exit condition
    isFinished = true;
    updateControlsForFinishedState();
}


// --- Utility Functions ---
function exportPersonas() {
    if (personas.length === 0) {
        alert("エクスポートする議論用ペルソナがありません。");
        return;
    }
    const jsonString = JSON.stringify(personas, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai-discussion-personas.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportAdminPersonas() {
    if (adminPersonas.length === 0) {
        alert("エクスポートする管理人AIペルソナがありません。");
        return;
    }
    const jsonString = JSON.stringify(adminPersonas, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai-admin-personas.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function downloadThreadAsJSON() {
    if (!currentThread) {
        alert("ダウンロードするスレッドがありません。");
        return;
    }
    const jsonString = JSON.stringify(currentThread, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `thread-${currentThread.title}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

async function downloadThreadAsImage() {
    const button = document.getElementById('exportImageAction');
    if (!currentThread) {
        alert("保存するスレッドがありません。");
        return;
    }
    if (button.classList.contains('is-loading')) return; // Prevent multiple clicks

    const textSpan = button.querySelector('span');
    const originalText = textSpan.textContent;

    textSpan.textContent = '画像を生成中...';
    button.classList.add('is-loading', 'opacity-50', 'pointer-events-none');

    try {
        const canvas = await html2canvas(document.getElementById('threadParent'), {
            backgroundColor: '#1e293b', // slate-800
            useCORS: true
        });
        const imageURL = canvas.toDataURL('image/png');
        
        const a = document.createElement('a');
        a.href = imageURL;
        a.download = `thread-${currentThread.title}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

    } catch (error) {
        console.error("画像の生成に失敗しました:", error);
        alert("画像の生成に失敗しました。コンソールを確認してください。");
    } finally {
        textSpan.textContent = originalText;
        button.classList.remove('is-loading', 'opacity-50', 'pointer-events-none');
    }
}


// Add a simple CSS animation for new posts
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
`;
document.head.appendChild(style);

// --- Thread Management Modal ---
function openThreadListModal() {
    renderThreadList();
    threadListModal.classList.remove('hidden');
    threadListModal.classList.add('flex');
}

function closeThreadListModal() {
    threadListModal.classList.add('hidden');
    threadListModal.classList.remove('flex');
}

function renderThreadList() {
    threadListContainer.innerHTML = '';
    if (threads.length === 0) {
        threadListContainer.innerHTML = `<p class="text-center text-slate-400 py-4">保存されたスレッドはありません。</p>`;
        return;
    }

    const sortedThreads = threads.sort((a, b) => b.createdAt - a.createdAt);

    sortedThreads.forEach(thread => {
        const threadItem = document.createElement('div');
        threadItem.className = 'flex items-center justify-between py-3 border-b border-slate-700 last:border-b-0';
        
        const timestamp = new Date(thread.createdAt).toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });

        threadItem.innerHTML = `
            <div class="flex-grow overflow-hidden pr-4">
                <p class="font-semibold text-slate-200 truncate" title="${thread.title}">${thread.title}</p>
                <p class="text-sm text-slate-400">${timestamp} - ${thread.posts.length}レス</p>
            </div>
            <div class="flex-shrink-0 flex items-center space-x-2">
                <button data-id="${thread.id}" class="load-thread-btn bg-indigo-600 text-white py-1 px-3 rounded-lg hover:bg-indigo-700 text-sm">読み込む</button>
                <button data-id="${thread.id}" class="delete-thread-btn bg-red-600 text-white py-1 px-3 rounded-lg hover:bg-red-700 text-sm">削除</button>
            </div>
        `;
        threadListContainer.appendChild(threadItem);
    });
}

function handleThreadListClick(e) {
    const target = e.target;
    const id = target.dataset.id;
    if (!id) return;

    if (target.classList.contains('load-thread-btn')) {
        loadThread(id);
    } else if (target.classList.contains('delete-thread-btn')) {
        deleteThread(id);
    }
}

function loadThread(id) {
    const threadIndex = threads.findIndex(t => t.id === id);
    if (threadIndex === -1) {
        alert('スレッドが見つかりませんでした。');
        return;
    }
    
    currentThread = threads[threadIndex];
    currentThreadId = id;

    // Set state for potential resume
    isGenerating = false;
    isPaused = false;
    isFinished = true;
    responseCount = currentThread.posts.length - 1;
    discussionLanguage = currentThread.language || '日本語';
    
    // Set a sensible default for resuming, and load current settings for other params
    maxResponses = responseCount + 5; 
    referenceCount = parseInt(referenceCountInput.value, 10);
    responseLength = parseInt(responseLengthInput.value, 10);
    discussionModel = settingsModelSelection.value;
    currentDiscussionPersonas = [...personas];

    renderThread(currentThread.title);
    updateControlsForLoadedThread(); // Display resume controls
    
    closeThreadListModal();
    closeMenu();
}

function deleteThread(id) {
    const thread = threads.find(t => t.id === id);
    if (!thread) return;

    openConfirmationModal(
        'スレッドを削除しますか？',
        `「${thread.title}」を完全に削除します。この操作は元に戻せません。`,
        () => {
            threads = threads.filter(t => t.id !== id);
            saveThreadsToLocal();
            
            if (currentThread && currentThread.id === id) {
                clearThreadView();
            } else {
                renderThreadIndex(); // Update index if a different thread was deleted
            }
            // Also update the list in the modal if it's open
            if (!threadListModal.classList.contains('hidden')) {
                renderThreadList();
            }
        }
    );
}

function clearThreadView() {
    threadDisplayContainer.classList.add('hidden');
    threadIndexContainer.classList.remove('hidden');
    backToIndexBtn.classList.add('hidden');
    generationControls.classList.add('hidden');
    adminAiReasoning.textContent = '';
    
    currentThread = null;
    currentThreadId = null;
    renderThreadIndex();
}


// --- Thread Index and Search ---
function renderThreadIndex(threadsToRender = threads) {
    threadIndexList.innerHTML = '';
    const sortedThreads = [...threadsToRender].sort((a, b) => b.createdAt - a.createdAt);

    if (sortedThreads.length === 0) {
        threadIndexList.innerHTML = `
            <div class="text-center text-slate-400 py-10 bg-slate-800/50 rounded-lg">
                <p class="text-lg font-semibold text-slate-200">スレッドがありません</p>
                <p>右上の「スレッド操作」から新しいスレッドを作成してください。</p>
            </div>`;
        return;
    }

    sortedThreads.forEach(thread => {
        const item = document.createElement('div');
        item.className = 'bg-slate-800 p-4 rounded-lg shiny-border shadow-md hover:shadow-indigo-500/20 transition-all';
        const timestamp = new Date(thread.createdAt).toLocaleString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        });

        item.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex-grow overflow-hidden pr-4">
                    <p class="font-semibold text-slate-200 truncate cursor-pointer hover:text-indigo-400" title="${thread.title}" onclick="loadThread('${thread.id}')">${thread.title}</p>
                    <p class="text-sm text-slate-400">${timestamp} - ${thread.posts.length}レス</p>
                </div>
                <div class="flex-shrink-0 flex items-center space-x-2">
                    <button onclick="loadThread('${thread.id}')" class="bg-indigo-600 text-white py-1 px-3 rounded-lg hover:bg-indigo-700 text-sm font-semibold">読み込む</button>
                    <button onclick="deleteThread('${thread.id}')" class="bg-red-500/20 text-red-300 py-1 px-3 rounded-lg hover:bg-red-500/40 text-sm font-semibold">削除</button>
                </div>
            </div>`;
        threadIndexList.appendChild(item);
    });
}

function handleSearch() {
    const keyword = searchInput.value.trim().toLowerCase();
    if (!keyword) {
        renderThreadIndex(threads);
        return;
    }
    const filtered = threads.filter(t => t.title.toLowerCase().includes(keyword));
    renderThreadIndex(filtered);
}

async function handleAiSearch() {
    const keyword = searchInput.value.trim();
    if (!keyword) {
        alert('AI検索を行うキーワードを入力してください。');
        return;
    }

    aiSearchBtn.disabled = true;
    aiSearchBtnText.innerHTML = `<div class="loader spinner-small animate-spin mx-auto"></div>`;

    try {
        const threadData = threads.map(t => ({ 
            id: t.id, 
            title: t.title, 
            content: t.posts.map(p => p.content).slice(0, 5).join(' ') // First 5 posts for brevity
        }));
        
        const systemPrompt = `You are a highly intelligent search AI. Your task is to find threads relevant to a user's query from a provided list.
Return the result as a single JSON object with one key: "relevant_ids". This key should hold an array of thread IDs, sorted from most to least relevant.
Do not include any other text, explanations, or markdown formatting.`;
        
        const userPrompt = `Query: "${keyword}"\n\nThreads Data:\n${JSON.stringify(threadData)}`;

        const result = await callGemini(systemPrompt, userPrompt, { responseMimeType: 'application/json', model: settingsModelSelection.value });

        if (result && Array.isArray(result.relevant_ids)) {
            const relevantThreads = result.relevant_ids
                .map(id => threads.find(t => t.id === id))
                .filter(Boolean); // Filter out any undefined if IDs don't match
            renderThreadIndex(relevantThreads);
        } else {
             renderThreadIndex([]); // Show no results if response is invalid
        }
    } catch (error) {
        alert(`AI検索に失敗しました: ${error.message}`);
        renderThreadIndex(threads); // Show all threads on failure
    } finally {
        aiSearchBtn.disabled = false;
        aiSearchBtnText.textContent = 'AI検索';
    }
}


// --- Help Chat Logic ---
function switchHelpTab(tab) {
    if (tab === 'guide') {
        helpTabGuide.className = 'whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-400 text-indigo-400';
        helpTabChat.className = 'whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500';
        helpPanelGuide.classList.remove('hidden');
        helpPanelChat.classList.add('hidden');
    } else {
        helpTabChat.className = 'whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-400 text-indigo-400';
        helpTabGuide.className = 'whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500';
        helpPanelChat.classList.remove('hidden');
        helpPanelChat.classList.add('flex');
        helpPanelGuide.classList.add('hidden');
    }
}

function addChatMessage(sender, message) {
    const messageElement = document.createElement('div');
    if (sender === 'ai') {
        const adminPersona = adminPersonas.find(p => p.id.toString() === adminAiPersonaSelection.value);
        const adminEmoji = adminPersona ? adminPersona.emoji : 'AI';
        const adminName = adminPersona ? adminPersona.name.substring(0,2) : 'AI';
        const renderedMessage = DOMPurify.sanitize(marked.parse(message));

        messageElement.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold" title="${adminPersona.name}">${adminEmoji}</div>
                <div class="bg-slate-700 rendered-markdown rounded-lg p-3 max-w-[80%] text-sm text-slate-200">
                     ${renderedMessage}
                </div>
            </div>`;
    } else { // user
        messageElement.innerHTML = `
            <div class="flex items-start gap-3 justify-end">
                <div class="bg-indigo-500 text-white rounded-lg p-3 max-w-[80%]">
                    <p class="text-sm">${message.replace(/\n/g, '<br>')}</p>
                </div>
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-slate-600 flex items-center justify-center text-slate-300 font-bold">You</div>
            </div>`;
    }
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function resetHelpChat() {
    chatMessages.innerHTML = '';
    const adminPersona = adminPersonas.find(p => p.id.toString() === adminAiPersonaSelection.value);
    const welcomeMessage = adminPersona ? 'こんにちは！アプリの使い方で分からないことがあれば、なんでも聞いてくださいね♪' : 'ようこそ！ご質問をどうぞ。';
    addChatMessage('ai', welcomeMessage);
    switchHelpTab('guide');
}

async function handleChatSend() {
    const userInput = chatInput.value.trim();
    if (!userInput) return;

    addChatMessage('user', userInput);
    chatInput.value = '';
    chatInput.disabled = true;
    chatSendBtn.disabled = true;
    aiTypingIndicator.classList.remove('hidden');

    try {
        const lang = settingsLanguageSelection.value;
        const adminPersonaId = adminAiPersonaSelection.value;
        const adminPersona = adminPersonas.find(p => p.id.toString() === adminPersonaId);
        
        const systemPrompt = adminPersona ? adminPersona.prompt : 'あなたは親切なアシスタントです。';

        const context = [...document.querySelectorAll('#helpPanelGuide section')].map(s => s.innerText).join('\n\n');
        const userPrompt = `あなたは「AI自動生成掲示板」の操作方法を案内するアシスタントです。あなたのペルソナ（性格）はシステムプロンプトに設定されています。そのペルソナとして、以下のアプリ仕様を参考にユーザーの質問に答えてください。回答は常に、指定されたデフォルト言語（${lang}）で行ってください。

# アプリの仕様
${context}

# ユーザーの質問
${userInput}`;

        const response = await callGemini(systemPrompt, userPrompt, { model: settingsModelSelection.value });
        addChatMessage('ai', response);

    } catch(error) {
        addChatMessage('ai', '申し訳ありません、エラーが発生してしまいました…😥 もう一度試していただけますか？');
        console.error('Help Chat Error:', error);
    } finally {
        aiTypingIndicator.classList.add('hidden');
        chatInput.disabled = false;
        chatSendBtn.disabled = false;
        chatInput.focus();
    }
}


// --- Event Listeners ---
addPersonaBtn.addEventListener('click', () => addPersona(false));
addAdminPersonaBtn.addEventListener('click', () => addPersona(true));

startThreadBtn.addEventListener('click', startDiscussion);
openMenuBtn.addEventListener('click', openMenu);
closeMenuBtn.addEventListener('click', closeMenu);
menuBackdrop.addEventListener('click', closeMenu);
settingsModelSelection.addEventListener('change', saveSettingsToLocal);
apiKeyInput.addEventListener('input', saveSettingsToLocal);
settingsLanguageSelection.addEventListener('change', saveSettingsToLocal);
adminAiPersonaSelection.addEventListener('change', saveSettingsToLocal);


// Edit Modal Listeners
closeEditModalBtn.addEventListener('click', closeEditModal);
cancelEditBtn.addEventListener('click', closeEditModal);
savePersonaBtn.addEventListener('click', savePersona);

// JSON Edit Modal Listeners
editJsonBtn.addEventListener('click', openJsonModal);
closeJsonModalBtn.addEventListener('click', closeJsonModal);
cancelJsonEditBtn.addEventListener('click', closeJsonModal);
saveJsonBtn.addEventListener('click', saveJsonChanges);
formatJsonBtn.addEventListener('click', formatJson);

// Admin JSON Modal Listeners
closeAdminJsonModalBtn.addEventListener('click', closeAdminJsonModal);
cancelAdminJsonEditBtn.addEventListener('click', closeAdminJsonModal);
saveAdminJsonBtn.addEventListener('click', saveAdminJsonChanges);
formatAdminJsonBtn.addEventListener('click', formatAdminJson);

// Restore Backup Listeners
openRestoreModalBtn.addEventListener('click', openRestoreModal);
closeRestoreModalBtn.addEventListener('click', closeRestoreModal);
cancelRestoreBtn.addEventListener('click', closeRestoreModal);
backupListContainer.addEventListener('click', handleRestoreClick);

// Admin Restore Listeners
closeAdminRestoreModalBtn.addEventListener('click', closeAdminRestoreModal);
cancelAdminRestoreBtn.addEventListener('click', closeAdminRestoreModal);
adminBackupListContainer.addEventListener('click', handleAdminRestoreClick);


// Thread List Listeners
closeThreadListModalBtn.addEventListener('click', closeThreadListModal);
cancelThreadListBtn.addEventListener('click', closeThreadListModal);
threadListContainer.addEventListener('click', handleThreadListClick);


// Confirmation Modal Listeners
cancelConfirmBtn.addEventListener('click', closeConfirmationModal);
confirmActionBtn.addEventListener('click', () => {
    if (confirmationCallback) {
        confirmationCallback();
    }
    closeConfirmationModal();
});


// Create Thread Modal Listeners
closeCreateThreadModalBtn.addEventListener('click', closeCreateThreadModal);
cancelCreateThreadBtn.addEventListener('click', closeCreateThreadModal);
addUrlBtn.addEventListener('click', addUrlToList);
generateFromSourceBtn.addEventListener('click', handleGenerateFromSource);
tabUrl.addEventListener('click', () => switchTab('url'));
tabText.addEventListener('click', () => switchTab('text'));
// Generation Control Listeners
pauseResumeBtn.addEventListener('click', handlePauseResume);
stopBtn.addEventListener('click', handleStop);

// Persona Management Listeners
const importFileInput = document.getElementById('importFileInput');
const importPersonasBtn = document.getElementById('importPersonasBtn');
const exportPersonasBtn = document.getElementById('exportPersonasBtn');

function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
                throw new Error("JSONが配列形式ではありません。");
            }

            let addedCount = 0;
            const existingUids = new Set(personas.map(p => p.uid));

            imported.forEach(p => {
                if (p && p.name && p.prompt && p.uid && p.emoji) {
                    if (!existingUids.has(p.uid)) {
                        personas.push(p);
                        existingUids.add(p.uid);
                        addedCount++;
                    }
                }
            });

            if (addedCount > 0) {
                createBackup();
                savePersonasToLocal();
                renderPersonas();
                alert(`${addedCount}件の新しいペルソナをインポートしました。`);
            } else {
                alert("新しいペルソナはありませんでした。(UIDが重複している可能性があります)");
            }

        } catch (error) {
            alert(`ファイルの読み込みまたは解析に失敗しました: ${error.message}`);
        } finally {
            importFileInput.value = '';
        }
    };
    reader.readAsText(file);
}

function handleAdminImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
                throw new Error("JSONが配列形式ではありません。");
            }

            let addedCount = 0;
            const existingUids = new Set(adminPersonas.map(p => p.uid));

            imported.forEach(p => {
                if (p && p.name && p.prompt && p.uid && p.emoji) {
                    if (!existingUids.has(p.uid)) {
                        adminPersonas.push(p);
                        existingUids.add(p.uid);
                        addedCount++;
                    }
                }
            });

            if (addedCount > 0) {
                createAdminBackup();
                saveAdminPersonasToLocal();
                renderAdminPersonas();
                alert(`${addedCount}件の新しい管理人AIペルソナをインポートしました。`);
            } else {
                alert("新しい管理人AIペルソナはありませんでした。(UIDが重複している可能性があります)");
            }

        } catch (error) {
            alert(`ファイルの読み込みまたは解析に失敗しました: ${error.message}`);
        } finally {
            importAdminFileInput.value = '';
        }
    };
    reader.readAsText(file);
}

importPersonasBtn.addEventListener('click', () => importFileInput.click());
importFileInput.addEventListener('change', handleImport);
exportPersonasBtn.addEventListener('click', exportPersonas);

// Admin Persona Management Listeners
importAdminPersonasBtn.addEventListener('click', () => importAdminFileInput.click());
importAdminFileInput.addEventListener('change', handleAdminImport);
exportAdminPersonasBtn.addEventListener('click', exportAdminPersonas);
editAdminJsonBtn.addEventListener('click', openAdminJsonModal);
openAdminRestoreModalBtn.addEventListener('click', openAdminRestoreModal);


// Header listeners
threadActionsBtn.addEventListener('click', () => threadActionsDropdown.classList.toggle('hidden'));
newThreadBtn.addEventListener('click', (e) => {
    e.preventDefault();
    openCreateThreadModal();
    threadActionsDropdown.classList.add('hidden');
});
loadThreadBtn.addEventListener('click', (e) => {
    e.preventDefault();
    openThreadListModal();
    threadActionsDropdown.classList.add('hidden');
});
exportJsonAction.addEventListener('click', (e) => {
    e.preventDefault();
    downloadThreadAsJSON();
    threadActionsDropdown.classList.add('hidden');
});
exportImageAction.addEventListener('click', (e) => {
    e.preventDefault();
    downloadThreadAsImage();
    threadActionsDropdown.classList.add('hidden');
});
window.addEventListener('click', (e) => {
    if (!threadActionsContainer.contains(e.target)) {
        threadActionsDropdown.classList.add('hidden');
    }
});
backToIndexBtn.addEventListener('click', clearThreadView);

helpBtn.addEventListener('click', openHelpModal);
closeHelpModalBtn.addEventListener('click', closeHelpModal);
helpModal.addEventListener('click', (e) => {
    if (e.target === helpModal) {
        closeHelpModal();
    }
});
// Help Chat Listeners
helpTabGuide.addEventListener('click', () => switchHelpTab('guide'));
helpTabChat.addEventListener('click', () => switchHelpTab('chat'));
chatSendBtn.addEventListener('click', handleChatSend);
chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        handleChatSend();
    }
});


// Search Listeners
searchBtn.addEventListener('click', handleSearch);
searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        handleSearch();
    }
});
aiSearchBtn.addEventListener('click', handleAiSearch);


// --- Initial Render ---
function initializeApp() {
    loadPersonasFromLocal();
    loadAdminPersonasFromLocal();
    migrateAdminPersona(); // Move default admin if necessary
    ensureDefaultAdminPersona();
    if (ensureDefaultDiscussionPersonas()) {
        savePersonasToLocal();
    }
    loadBackupsFromLocal();
    loadAdminBackupsFromLocal();
    loadThreadsFromLocal();
    ensureSampleThreads();
    renderPersonas(); 
    renderAdminPersonas();
    loadSettingsFromLocal();
    renderThreadIndex();
}

initializeApp();

</script>
</body>
</html>



